<div class="weight-history-page" fdPageContainer>
    <fd-page-header
        class="weight-history-page__header"
        [title]="'WEIGHT_HISTORY.TITLE' | translate"
        [subtitle]="'WEIGHT_HISTORY.SUBTITLE' | translate"
    />

    <fd-page-body>
        <fd-period-filter
            class="weight-history-page__period"
            [tabs]="rangeTabs"
            [selectedValue]="selectedRange()"
            [rangeControl]="customRangeControl"
            [displayRange]="currentRange()"
            [startLabel]="'WEIGHT_HISTORY.CUSTOM_RANGE_FROM_LABEL' | translate"
            [endLabel]="'WEIGHT_HISTORY.CUSTOM_RANGE_TO_LABEL' | translate"
            [startPlaceholder]="'WEIGHT_HISTORY.CUSTOM_RANGE_PLACEHOLDER' | translate"
            [endPlaceholder]="'WEIGHT_HISTORY.CUSTOM_RANGE_PLACEHOLDER' | translate"
            (rangeChange)="changeRange($event)"
        />

        <fd-ui-card class="weight-history-page__card weight-history-page__card--chart" [title]="'WEIGHT_HISTORY.CHART_TITLE' | translate">
            @if (isSummaryLoading()) {
                <div class="weight-history-page__loader">
                    {{ 'WEIGHT_HISTORY.LOADING' | translate }}
                </div>
            } @else {
                @if (summaryPoints().length > 0) {
                    <canvas
                        baseChart
                        class="weight-history-page__chart-canvas"
                        [type]="'line'"
                        [data]="chartData()"
                        [options]="chartOptions"
                        [legend]="false"
                    ></canvas>
                } @else {
                    <p class="weight-history-page__empty-chart">
                        {{ 'WEIGHT_HISTORY.NO_DATA_FOR_CHART' | translate }}
                    </p>
                }
            }
        </fd-ui-card>

        <fd-ui-card class="weight-history-page__card weight-history-page__card--bmi" [title]="'WEIGHT_HISTORY.BMI_CARD_TITLE' | translate">
            @if (bmiValue() !== null) {
                @if (bmiStatusInfo(); as bmiInfo) {
                    <div class="weight-history-page__bmi-top">
                        <p class="weight-history-page__bmi-note">
                            {{ 'WEIGHT_HISTORY.BMI_NOTE' | translate }}
                        </p>
                        <div class="weight-history-page__bmi-scale">
                            <div class="weight-history-page__bmi-segments">
                                @for (segment of bmiSegments; track segment.labelKey) {
                                    <div
                                        class="weight-history-page__bmi-segment"
                                        [ngClass]="segment.class"
                                        [style.width]="getBmiSegmentWidth(segment)"
                                    >
                                        <span>{{ segment.labelKey | translate }}</span>
                                    </div>
                                }
                            </div>
                            <div class="weight-history-page__bmi-pointer" [style.left]="bmiPointerPosition()">
                                <div class="weight-history-page__bmi-pointer-dot"></div>
                                <span>{{ bmiValue() }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="weight-history-page__bmi-bottom">
                        <div class="weight-history-page__bmi-footer">
                            <div class="weight-history-page__bmi-value">
                                {{ 'WEIGHT_HISTORY.BMI_CURRENT' | translate }}:
                                <strong>{{ bmiValue() }}</strong>
                            </div>
                            <div class="weight-history-page__bmi-status" [ngClass]="bmiInfo.class">
                                {{ bmiInfo.labelKey | translate }}
                            </div>
                        </div>
                        <p class="weight-history-page__bmi-description">
                            {{ bmiInfo.descriptionKey | translate }}
                        </p>
                    </div>
                }
            } @else {
                <p class="weight-history-page__empty">
                    {{ 'WEIGHT_HISTORY.BMI_NO_DATA' | translate }}
                </p>
            }
        </fd-ui-card>

        <div class="weight-history-page__content weight-history-page__content--form">
            <fd-ui-card class="weight-history-page__card weight-history-page__card--form" [title]="'WEIGHT_HISTORY.ADD_ENTRY_TITLE' | translate">
                <form class="weight-history-page__form" [formGroup]="form" (ngSubmit)="submit()">
                    <div class="weight-history-page__form-row">
                        <fd-ui-date-input class="weight-history-page__form-control"
                            formControlName="date"
                            [label]="'WEIGHT_HISTORY.DATE_LABEL' | translate"
                            [placeholder]="'WEIGHT_HISTORY.DATE_PLACEHOLDER' | translate"
                         />

                        <fd-ui-input class="weight-history-page__form-control"
                            formControlName="weight"
                            type="number"
                            [step]="0.1"
                            [label]="'WEIGHT_HISTORY.WEIGHT_LABEL' | translate"
                            [placeholder]="'WEIGHT_HISTORY.WEIGHT_PLACEHOLDER' | translate"
                         />
                    </div>

                    <div class="weight-history-page__form-actions">
                        <fd-ui-button
                            [disabled]="isSaving()"
                            type="submit"
                        >
                            @if (isEditing()) {
                                {{ 'WEIGHT_HISTORY.UPDATE' | translate }}
                            } @else {
                                {{ 'WEIGHT_HISTORY.ADD' | translate }}
                            }
                        </fd-ui-button>
                        @if (isEditing()) {
                            <fd-ui-button
                                type="button"
                                variant="secondary"
                                fill="text"
                                (click)="cancelEdit()"
                            >
                                {{ 'WEIGHT_HISTORY.CANCEL_EDIT' | translate }}
                            </fd-ui-button>
                        }
                    </div>
                </form>
            </fd-ui-card>

            <fd-ui-card class="weight-history-page__card weight-history-page__card--goal" [title]="'WEIGHT_HISTORY.GOAL_CARD_TITLE' | translate">
                <div class="weight-history-page__goal-body">
                    <fd-ui-input class="weight-history-page__goal-input"
                        type="number"
                        [step]="0.1"
                        [placeholder]="'WEIGHT_HISTORY.GOAL_PLACEHOLDER' | translate"
                        [suffixButtonIcon]="desiredWeightControl.value ? 'backspace' : undefined"
                        (suffixButtonClicked)="desiredWeightControl.setValue('')"
                        [formControl]="desiredWeightControl"
                     />
                    <div class="weight-history-page__goal-actions">
                        <fd-ui-button
                            type="button"
                            (click)="saveDesiredWeight()"
                            [disabled]="isDesiredWeightSaving()"
                        >
                            {{ 'WEIGHT_HISTORY.SAVE_GOAL' | translate }}
                        </fd-ui-button>
                    </div>
                </div>
            </fd-ui-card>
        </div>

        <div class="weight-history-page__content weight-history-page__content--full">
            <fd-ui-card class="weight-history-page__card weight-history-page__card--entries" [title]="'WEIGHT_HISTORY.HISTORY_TITLE' | translate">
                @if (isLoading()) {
                    <div class="weight-history-page__loader">
                        {{ 'WEIGHT_HISTORY.LOADING' | translate }}
                    </div>
                } @else {
                    @if (entriesDescending().length === 0) {
                        <div class="weight-history-page__empty">
                            {{ 'WEIGHT_HISTORY.NO_ENTRIES' | translate }}
                        </div>
                    } @else {
                        <div class="weight-history-page__entries">
                            @for (entry of entriesDescending(); track entry.id) {
                                <div class="weight-history-page__entry">
                                    <div class="weight-history-page__entry-date">
                                        {{ entry.date | date:'dd.MM.yyyy' }}
                                    </div>
                                    <div class="weight-history-page__entry-weight">
                                        {{ entry.weight | number: '1.0-2' }}
                                        {{ 'DASHBOARD.KG' | translate }}
                                    </div>
                                    <div class="weight-history-page__entry-actions">
                                        <fd-ui-button
                                            type="button"
                                            fill="text"
                                            variant="secondary"
                                            icon="edit"
                                            (click)="startEdit(entry)"
                                        >
                                            {{ 'WEIGHT_HISTORY.EDIT' | translate }}
                                        </fd-ui-button>
                                        <fd-ui-button
                                            type="button"
                                            fill="text"
                                            variant="danger"
                                            icon="delete"
                                            (click)="deleteEntry(entry)"
                                        >
                                            {{ 'WEIGHT_HISTORY.DELETE' | translate }}
                                        </fd-ui-button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </fd-ui-card>
        </div>
    </fd-page-body>
</div>

