<div class="product-manage" fdPageContainer>
    <fd-page-header
        class="product-manage__header"
        [title]="product() ? ('PRODUCT_MANAGE.EDIT_TITLE' | translate) : ('PRODUCT_MANAGE.ADD_TITLE' | translate)"
        [subtitle]="'PRODUCT_MANAGE.SUBTITLE' | translate"
    >
        <ng-container fdPageHeaderActions>
            @if (canShowDeleteButton) {
                <fd-ui-button
                    type="button"
                    class="product-manage__delete-button"
                    variant="danger"
                    icon="delete"
                    [disabled]="isDeleting()"
                    (click)="onDeleteProduct()"
                >
                    {{ 'PRODUCT_MANAGE.DELETE_BUTTON' | translate }}
                </fd-ui-button>
            }
        </ng-container>
    </fd-page-header>

    <form class="product-manage__form" [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="product-manage__grid">
            <div class="product-manage__column product-manage__column--primary">
                <fd-ui-card
                    class="product-manage__card product-manage__card--basic"
                    appearance="entry"
                    [title]="'PRODUCT_MANAGE.BASIC_INFO' | translate"
                >
                    <div class="product-manage__hero">
                        <div class="product-manage__image">
                            <fd-image-upload-field
                                formControlName="imageUrl"
                                [description]="'PRODUCT_MANAGE.IMAGE_DESCRIPTION' | translate"
                                [recommendedSize]="'512 x 512'"
                                [cropEnabled]="true"
                                [cropSize]="512"
                                [cropAspectRatio]="1"
                            />
                        </div>
                        <div class="product-manage__hero-field">
                            <fd-ui-input formControlName="name"
                                size="lg"
                                [label]="'PRODUCT_MANAGE.NAME' | translate"
                                [placeholder]="'PRODUCT_MANAGE.NAME_PLACEHOLDER' | translate"
                                [required]="true"
                                [error]="getControlError('name')"
                             />
                        </div>
                        <div class="product-manage__hero-field">
                            <fd-ui-input formControlName="barcode"
                                size="lg"
                                [label]="'PRODUCT_MANAGE.BARCODE' | translate"
                                [placeholder]="'PRODUCT_MANAGE.BARCODE_PLACEHOLDER' | translate"
                                [suffixButtonIcon]="'qr_code_scanner'"
                                [suffixButtonAriaLabel]="'PRODUCT_MANAGE.SCAN_BARCODE' | translate"
                                (suffixButtonClicked)="openBarcodeScanner()"
                             />
                        </div>
                        <div class="product-manage__hero-field">
                            <fd-ui-select formControlName="productType"
                                size="lg"
                                [label]="'PRODUCT_MANAGE.PRODUCT_TYPE' | translate"
                                [placeholder]="'PRODUCT_MANAGE.PRODUCT_TYPE_PLACEHOLDER' | translate"
                                [options]="productTypeSelectOptions"
                                [required]="true"
                                [error]="getControlError('productType')"
                             />
                        </div>
                    </div>
                    <div class="product-manage__basic-grid">
                        <div class="product-manage__serving-row product-manage__field--full">
                            <div class="product-manage__serving-part">
                                <fd-ui-input formControlName="defaultPortionAmount"
                                    type="number"
                                    [label]="'PRODUCT_MANAGE.DEFAULT_PORTION_AMOUNT' | translate"
                                    [placeholder]="'PRODUCT_MANAGE.DEFAULT_PORTION_PLACEHOLDER' | translate"
                                    [required]="true"
                                    [error]="getControlError('defaultPortionAmount')"
                                 />
                            </div>
                            <div class="product-manage__serving-part">
                                <fd-ui-select formControlName="baseUnit"
                                    [label]="'PRODUCT_MANAGE.DEFAULT_SERVING_UNIT' | translate"
                                    [options]="unitOptions"
                                    [required]="true"
                                    [error]="getControlError('baseUnit')"
                                 />
                            </div>
                        </div>
                    </div>
                </fd-ui-card>

                <fd-ui-card
                    class="product-manage__card product-manage__card--basic"
                    appearance="entry"
                    [title]="'PRODUCT_MANAGE.TRACKING_PREFERENCES' | translate"
                >
                    <div class="product-manage__basic-grid">
                        <div class="product-manage__field product-manage__field--full">
                            <fd-ui-select formControlName="visibility"
                                [label]="'PRODUCT_MANAGE.VISIBILITY' | translate"
                                [required]="true"
                                [options]="visibilitySelectOptions"
                                [error]="getControlError('visibility')"
                             />
                        </div>
                        <div class="product-manage__field product-manage__field--full">
                            <fd-ui-textarea formControlName="comment"
                                [label]="'PRODUCT_MANAGE.COMMENT' | translate"
                                [placeholder]="'PRODUCT_MANAGE.COMMENT_PLACEHOLDER' | translate"
                                [rows]="4"
                             />
                        </div>
                    </div>
                </fd-ui-card>
            </div>

            <div class="product-manage__column product-manage__column--secondary">
                <div class="product-manage__sticky-stack">
                    <fd-ui-card
                        class="product-manage__card product-manage__card--nutrition"
                        appearance="entry"
                        [title]="'PRODUCT_MANAGE.NUTRITION_VALUE' | translate"
                    >
                        <div class="product-manage__nutrition">
                            <fd-ui-nutrient-input
                                class="product-manage__nutrition-input product-manage__nutrition-input--serving"
                                formControlName="baseAmount"
                                type="number"
                                size="md"
                                variant="tinted"
                                valueAlign="left"
                                [labelUppercase]="false"
                                [label]="'PRODUCT_MANAGE.DEFAULT_SERVING_WITH_UNIT' | translate: { unit: baseUnitLabel }"
                                [placeholder]="'PRODUCT_MANAGE.DEFAULT_SERVING_PLACEHOLDER' | translate"
                                [required]="true"
                                [tintColor]="'rgba(148, 163, 184, 0.10)'"
                            />

                            <fd-ui-nutrient-input
                                class="product-manage__nutrition-input product-manage__nutrition-input--calories"
                                formControlName="caloriesPerBase"
                                type="number"
                                size="lg"
                                icon="local_fire_department"
                                [label]="'PRODUCT_MANAGE.CALORIES' | translate"
                                placeholder="0"
                                [required]="true"
                                [tintColor]="nutrientFillColors.calories"
                                [textColor]="nutrientTextColors.calories"
                            />
                            @if (caloriesError()) {
                                <div class="product-manage__nutrition-errors">
                                    {{ caloriesError() }}
                                </div>
                            }

                            <div class="product-manage__nutrition-grid">
                                <fd-ui-nutrient-input
                                    class="product-manage__nutrition-input product-manage__nutrition-input--macro product-manage__nutrition-input--proteins"
                                    formControlName="proteinsPerBase"
                                    type="number"
                                    size="md"
                                    icon="fitness_center"
                                    [label]="'PRODUCT_MANAGE.PROTEINS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [tintColor]="nutrientFillColors.proteins"
                                    [textColor]="nutrientTextColors.proteins"
                                />
                                <fd-ui-nutrient-input
                                    class="product-manage__nutrition-input product-manage__nutrition-input--macro product-manage__nutrition-input--fats"
                                    formControlName="fatsPerBase"
                                    type="number"
                                    size="md"
                                    icon="opacity"
                                    [label]="'PRODUCT_MANAGE.FATS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [tintColor]="nutrientFillColors.fats"
                                    [textColor]="nutrientTextColors.fats"
                                />
                                <fd-ui-nutrient-input
                                    class="product-manage__nutrition-input product-manage__nutrition-input--macro product-manage__nutrition-input--carbs"
                                    formControlName="carbsPerBase"
                                    type="number"
                                    size="md"
                                    icon="grain"
                                    [label]="'PRODUCT_MANAGE.CARBS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [tintColor]="nutrientFillColors.carbs"
                                    [textColor]="nutrientTextColors.carbs"
                                />
                                <fd-ui-nutrient-input
                                    class="product-manage__nutrition-input product-manage__nutrition-input--macro product-manage__nutrition-input--fiber"
                                    formControlName="fiberPerBase"
                                    type="number"
                                    size="md"
                                    icon="spa"
                                    [label]="'PRODUCT_MANAGE.FIBER' | translate"
                                    placeholder="0"
                                    [tintColor]="nutrientFillColors.fiber"
                                    [textColor]="nutrientTextColors.fiber"
                                />
                            </div>
                            @if (macrosError()) {
                                <div class="product-manage__nutrition-errors">
                                    {{ macrosError() }}
                                </div>
                            }

                            <fd-ui-nutrient-input
                                class="product-manage__nutrition-input product-manage__nutrition-input--alcohol"
                                formControlName="alcoholPerBase"
                                type="number"
                                size="md"
                                icon="wine_bar"
                                variant="tinted"
                                valueAlign="left"
                                [labelUppercase]="false"
                                [label]="'PRODUCT_MANAGE.ALCOHOL' | translate"
                                placeholder="0"
                                [tintColor]="'rgba(148, 163, 184, 0.10)'"
                            />
                        </div>
                        @if (nutritionWarning(); as warning) {
                            <div class="product-manage__nutrition-warning">
                                {{ 'PRODUCT_MANAGE.CALORIES_MISMATCH_WARNING' | translate: {
                                    expected: warning.expectedCalories,
                                    actual: warning.actualCalories
                                } }}
                            </div>
                        }
                    </fd-ui-card>
                </div>
            </div>
        </div>

        <div class="product-manage__footer">
            <div class="product-manage__footer-actions">
                <fd-ui-button
                    type="button"
                    fill="outline"
                    variant="primary"
                    icon="arrow_back"
                    (click)="onCancel()"
                >
                    {{ 'PRODUCT_MANAGE.CANCEL_BUTTON' | translate }}
                </fd-ui-button>
                @if (product()) {
                    <fd-ui-button
                        type="submit"
                        class="product-manage__action-button"
                        icon="save"
                    >
                        {{ 'PRODUCT_MANAGE.SAVE_BUTTON' | translate }}
                    </fd-ui-button>
                } @else {
                    <fd-ui-button
                        type="submit"
                        class="product-manage__action-button"
                        icon="add"
                    >
                        {{ 'PRODUCT_MANAGE.ADD_BUTTON' | translate }}
                    </fd-ui-button>
                }
            </div>
            <fd-ui-form-error class="product-manage__footer-error" [error]="globalError()" />
        </div>
    </form>
</div>
