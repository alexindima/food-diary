<div class="consumption-manage" fdPageContainer>
    <fd-page-header
        class="consumption-manage__header"
        [title]="consumption() ? ('CONSUMPTION_MANAGE.EDIT_TITLE' | translate) : ('CONSUMPTION_MANAGE.ADD_TITLE' | translate)"
        [subtitle]="'CONSUMPTION_MANAGE.SUBTITLE' | translate"
    />

    <form class="consumption-manage__form" [formGroup]="consumptionForm" (ngSubmit)="onSubmit()">
        <div class="consumption-manage__grid">
            <div class="consumption-manage__column consumption-manage__column--primary">
                <fd-ui-card class="consumption-manage__card" [title]="'CONSUMPTION_MANAGE.GENERAL_GROUP_TITLE' | translate">
                    <div class="consumption-manage__hero">
                        <div class="consumption-manage__image">
                            <fd-image-upload-field
                                formControlName="imageUrl"
                                [description]="'CONSUMPTION_MANAGE.IMAGE_DESCRIPTION' | translate"
                            />
                        </div>
                        <div class="consumption-manage__hero-fields">
                            <div class="consumption-manage__field-row">
                                <div class="consumption-manage__field">
                                    <fd-ui-date-input
                                        formControlName="date"
                                        size="lg"
                                        [label]="'CONSUMPTION_MANAGE.CHOOSE_DATE' | translate"
                                        [required]="true"
                                        [error]="getControlError('date')"
                                     />
                                </div>
                                <div class="consumption-manage__field">
                                    <fd-ui-time-input
                                        formControlName="time"
                                        size="lg"
                                        [label]="'CONSUMPTION_MANAGE.CHOOSE_TIME' | translate"
                                        [required]="true"
                                        [error]="getControlError('time')"
                                     />
                                </div>
                            </div>
                            <div class="consumption-manage__field">
                                <fd-ui-select
                                    formControlName="mealType"
                                    size="lg"
                                    [label]="'CONSUMPTION_MANAGE.MEAL_TYPE_LABEL' | translate"
                                    [placeholder]="'CONSUMPTION_MANAGE.MEAL_TYPE_PLACEHOLDER' | translate"
                                    [options]="mealTypeSelectOptions"
                                    [error]="getControlError('mealType')"
                                 />
                            </div>
                        </div>
                    </div>
                    <div class="consumption-manage__field consumption-manage__field--full">
                        <fd-ui-textarea
                            formControlName="comment"
                            size="lg"
                            [label]="'CONSUMPTION_MANAGE.COMMENT' | translate"
                            [placeholder]="'CONSUMPTION_MANAGE.COMMENT_PLACEHOLDER' | translate"
                            [rows]="3"
                         />
                    </div>
                </fd-ui-card>

                <fd-ui-card
                    class="consumption-manage__card"
                    [title]="'CONSUMPTION_MANAGE.SATIETY_SECTION_TITLE' | translate"
                >
                    <p class="consumption-manage__satiety-note">
                        {{ 'CONSUMPTION_MANAGE.SATIETY_SECTION_HINT' | translate }}
                    </p>
                    <div class="consumption-manage__satiety-grid">
                        <div class="consumption-manage__satiety-field">
                            <p class="consumption-manage__satiety-picker-label">
                                {{ 'CONSUMPTION_MANAGE.HUNGER_BEFORE_LABEL' | translate }}
                            </p>
                            @let beforeMeta = getSatietyLevelMeta(consumptionForm.controls.preMealSatietyLevel.value);
                            <button
                                type="button"
                                class="consumption-manage__satiety-card"
                                (click)="openSatietyDialog('preMealSatietyLevel')"
                                [style.--satiety-gradient]="beforeMeta.gradient"
                            >
                                <div class="consumption-manage__satiety-card-indicator">
                                    {{
                                        (consumptionForm.controls.preMealSatietyLevel.value ?? 0) > 0
                                            ? consumptionForm.controls.preMealSatietyLevel.value
                                            : '?'
                                    }}
                                </div>
                                <div class="consumption-manage__satiety-card-text">
                                    <span class="consumption-manage__satiety-card-title">
                                        {{ beforeMeta.label }}
                                    </span>
                                    <span class="consumption-manage__satiety-card-description">
                                        {{ beforeMeta.description }}
                                    </span>
                                </div>
                                <mat-icon>tune</mat-icon>
                            </button>
                        </div>
                        <div class="consumption-manage__satiety-field">
                            <p class="consumption-manage__satiety-picker-label">
                                {{ 'CONSUMPTION_MANAGE.HUNGER_AFTER_LABEL' | translate }}
                            </p>
                            @let afterMeta = getSatietyLevelMeta(consumptionForm.controls.postMealSatietyLevel.value);
                            <button
                                type="button"
                                class="consumption-manage__satiety-card"
                                (click)="openSatietyDialog('postMealSatietyLevel')"
                                [style.--satiety-gradient]="afterMeta.gradient"
                            >
                                <div class="consumption-manage__satiety-card-indicator">
                                    {{
                                        (consumptionForm.controls.postMealSatietyLevel.value ?? 0) > 0
                                            ? consumptionForm.controls.postMealSatietyLevel.value
                                            : '?'
                                    }}
                                </div>
                                <div class="consumption-manage__satiety-card-text">
                                    <span class="consumption-manage__satiety-card-title">
                                        {{ afterMeta.label }}
                                    </span>
                                    <span class="consumption-manage__satiety-card-description">
                                        {{ afterMeta.description }}
                                    </span>
                                </div>
                                <mat-icon>tune</mat-icon>
                            </button>
                        </div>
                    </div>
                </fd-ui-card>

                <div class="consumption-manage__items-section">
                    <div class="consumption-manage__items-header">
                        <h2 class="consumption-manage__section-title">
                            {{ 'CONSUMPTION_MANAGE.ITEMS_GROUP_TITLE' | translate }}
                        </h2>
                    </div>
                    <div class="consumption-manage__items-grid">
                        <fd-ui-card class="consumption-manage__card consumption-manage__card--items"
                            [title]="'CONSUMPTION_MANAGE.ITEMS_ADDED_TITLE' | translate"
                        >
                            <div class="consumption-items" formArrayName="items">
                                @for (item of items.controls; track item; let i = $index; let first = $first) {
                                    <div class="consumption-item-card" [formGroupName]="i">
                                        <div class="consumption-item__fields">
                                            <div class="consumption-item__row consumption-item__row--with-remove">
                                                <div class="consumption-item__field consumption-item__field--source">
                                                    <fd-ui-input
                                                        class="consumption-item__selector-input"
                                                        [ngModel]="getItemSourceName(i)"
                                                        [ngModelOptions]="{ standalone: true }"
                                                        [label]="'CONSUMPTION_MANAGE.ITEM_SOURCE_LABEL' | translate"
                                                        [placeholder]="'CONSUMPTION_MANAGE.ITEM_SOURCE_PLACEHOLDER' | translate"
                                                        [readonly]="true"
                                                        [prefixIcon]="getItemSourceIcon(i)"
                                                        [error]="getItemSourceError(i)"
                                                        (click)="onItemSourceClick(i)"
                                                    />
                                                </div>
                                                <div class="consumption-item__field consumption-item__field--amount">
                                                    <fd-ui-input formControlName="amount"
                                                        type="number"
                                                        [step]="0.01"
                                                        [label]="'CONSUMPTION_MANAGE.ADD_ITEM_ROW.AMOUNT' | translate"
                                                        [placeholder]="(getAmountPlaceholder(i) | translate)"
                                                        [required]="true"
                                                        [error]="getAmountControlError(i)"
                                                        [readonly]="!items.at(i).controls.product.value && !items.at(i).controls.recipe.value"
                                                     />
                                                </div>
                                                <fd-ui-button
                                                    type="button"
                                                    variant="danger"
                                                    fill="text"
                                                    icon="close"
                                                    [ariaLabel]="'CONSUMPTION_MANAGE.REMOVE_ITEM' | translate"
                                                    class="consumption-item__remove consumption-item__remove--inline"
                                                    [disabled]="first"
                                                    (click)="removeItem(i)"
                                                >
                                                    {{ 'CONSUMPTION_MANAGE.REMOVE_ITEM' | translate }}
                                                </fd-ui-button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="consumption-item__actions consumption-item__actions--stack">
                                <fd-ui-button
                                    type="button"
                                    icon="add"
                                    class="consumption-item__add"
                                    variant="secondary"
                                    fill="outline"
                                    (click)="addConsumptionItem()"
                                >
                                    {{ 'CONSUMPTION_MANAGE.ADD_ITEM' | translate }}
                                </fd-ui-button>
                            </div>
                            <fd-ui-form-error class="consumption-item__error"
                                [error]="items.invalid && items.touched ? ('FORM_ERRORS.NON_EMPTY_ARRAY' | translate) : null"
                             />
                        </fd-ui-card>

                        <fd-ui-card class="consumption-manage__card consumption-manage__card--items-ai"
                            [title]="'CONSUMPTION_MANAGE.ITEMS_AI_TITLE' | translate"
                        >
                            <p class="consumption-manage__items-hint">
                                {{ 'CONSUMPTION_MANAGE.ITEMS_AI_HINT' | translate }}
                            </p>
                            @if (aiSessions().length) {
                                <div class="consumption-manage__ai-summary-listing">
                                    @for (session of aiSessions(); track session; let idx = $index) {
                                        @let totals = getAiSessionTotals(session);
                                        <div class="consumption-manage__ai-summary">
                                            <div class="consumption-manage__ai-summary-header">
                                                <div class="consumption-manage__ai-summary-image">
                                                    @if (session.imageUrl) {
                                                        <img [src]="session.imageUrl" alt="" loading="lazy" />
                                                    } @else {
                                                        <mat-icon fontIcon="photo_camera"></mat-icon>
                                                    }
                                                </div>
                                                <div class="consumption-manage__ai-summary-heading">
                                                    <div class="consumption-manage__ai-summary-title">
                                                        {{ 'CONSUMPTION_MANAGE.ITEMS_AI_SUMMARY' | translate:{ count: session.items.length } }}
                                                    </div>
                                                    <div class="consumption-manage__ai-summary-stats">
                                                        <div class="consumption-manage__ai-summary-calories">
                                                            <span class="consumption-manage__ai-summary-label">
                                                                {{ 'GENERAL.NUTRIENTS.CALORIES' | translate }}:
                                                            </span>
                                                            <span>{{ formatAiMacro(totals.calories, 'GENERAL.UNITS.KCAL') }}</span>
                                                        </div>
                                                        <div class="consumption-manage__ai-summary-nutrients">
                                                            <span>
                                                                {{ 'GENERAL.NUTRIENTS.PROTEIN' | translate }}:
                                                                {{ formatAiMacro(totals.proteins, 'GENERAL.UNITS.G') }}
                                                            </span>
                                                            <span>
                                                                {{ 'GENERAL.NUTRIENTS.FAT' | translate }}:
                                                                {{ formatAiMacro(totals.fats, 'GENERAL.UNITS.G') }}
                                                            </span>
                                                            <span>
                                                                {{ 'GENERAL.NUTRIENTS.CARB' | translate }}:
                                                                {{ formatAiMacro(totals.carbs, 'GENERAL.UNITS.G') }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="consumption-manage__ai-summary-actions">
                                                    <button
                                                        type="button"
                                                        class="consumption-manage__ai-summary-action"
                                                        [attr.aria-label]="'CONSUMPTION_MANAGE.ITEMS_AI_EDIT' | translate"
                                                        (click)="onEditAiSession(idx)"
                                                    >
                                                        <mat-icon fontIcon="edit"></mat-icon>
                                                    </button>
                                                    <button
                                                        type="button"
                                                        class="consumption-manage__ai-summary-action consumption-manage__ai-summary-action--danger"
                                                        [attr.aria-label]="'CONSUMPTION_MANAGE.ITEMS_AI_DELETE' | translate"
                                                        (click)="onDeleteAiSession(idx)"
                                                    >
                                                        <mat-icon fontIcon="delete"></mat-icon>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="consumption-manage__ai-summary-body">
                                                <div class="consumption-manage__ai-summary-list">
                                                    @for (aiItem of session.items; track aiItem; let itemIdx = $index) {
                                                        <div class="consumption-manage__ai-summary-row">
                                                            <span class="consumption-manage__ai-summary-name">
                                                                {{ formatAiName(aiItem.nameLocal || aiItem.nameEn) }}
                                                            </span>
                                                            <span class="consumption-manage__ai-summary-amount">
                                                                {{ formatAiAmount(aiItem.amount, aiItem.unit) }}
                                                            </span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            <div class="consumption-item__actions consumption-item__actions--stack">
                                <fd-ui-button
                                    type="button"
                                    icon="photo_camera"
                                    class="consumption-item__add"
                                    variant="secondary"
                                    fill="outline"
                                    [disabled]="aiQuotaExceeded()"
                                    (click)="onAddConsumptionFromPhoto()"
                                >
                                    {{ 'CONSUMPTION_MANAGE.ADD_ITEM_FROM_PHOTO' | translate }}
                                </fd-ui-button>
                            </div>
                        </fd-ui-card>
                    </div>
                </div>
            </div>

            <div class="consumption-manage__column consumption-manage__column--secondary">
                <div class="consumption-manage__sticky-stack">
                    <fd-ui-card
                        class="consumption-manage__card consumption-manage__card--nutrition"
                        appearance="entry"
                        [title]="'PRODUCT_MANAGE.NUTRITION_VALUE' | translate"
                    >
                        <div class="consumption-manage__calories-header">
                            <fd-ui-checkbox formControlName="isNutritionAutoCalculated"
                                [label]="'CONSUMPTION_MANAGE.MANUAL_NUTRITION_AUTO' | translate"
                             />
                        </div>

                        <div class="consumption-manage__nutrition">
                            <fd-ui-nutrient-input
                                class="consumption-manage__nutrition-input consumption-manage__nutrition-input--calories"
                                formControlName="manualCalories"
                                type="number"
                                size="lg"
                                icon="local_fire_department"
                                [label]="'PRODUCT_MANAGE.CALORIES' | translate"
                                placeholder="0"
                                [required]="true"
                                [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                [tintColor]="nutrientFillColors.calories"
                                [textColor]="nutrientTextColors.calories"
                            />

                            <div class="consumption-manage__nutrition-grid">
                                <fd-ui-nutrient-input
                                    class="consumption-manage__nutrition-input consumption-manage__nutrition-input--macro"
                                    formControlName="manualProteins"
                                    type="number"
                                    size="md"
                                    icon="fitness_center"
                                    [label]="'PRODUCT_MANAGE.PROTEINS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                    [tintColor]="nutrientFillColors.proteins"
                                    [textColor]="nutrientTextColors.proteins"
                                />
                                <fd-ui-nutrient-input
                                    class="consumption-manage__nutrition-input consumption-manage__nutrition-input--macro"
                                    formControlName="manualFats"
                                    type="number"
                                    size="md"
                                    icon="opacity"
                                    [label]="'PRODUCT_MANAGE.FATS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                    [tintColor]="nutrientFillColors.fats"
                                    [textColor]="nutrientTextColors.fats"
                                />
                                <fd-ui-nutrient-input
                                    class="consumption-manage__nutrition-input consumption-manage__nutrition-input--macro"
                                    formControlName="manualCarbs"
                                    type="number"
                                    size="md"
                                    icon="grain"
                                    [label]="'PRODUCT_MANAGE.CARBS' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                    [tintColor]="nutrientFillColors.carbs"
                                    [textColor]="nutrientTextColors.carbs"
                                />
                                <fd-ui-nutrient-input
                                    class="consumption-manage__nutrition-input consumption-manage__nutrition-input--macro"
                                    formControlName="manualFiber"
                                    type="number"
                                    size="md"
                                    icon="spa"
                                    [label]="'PRODUCT_MANAGE.FIBER' | translate"
                                    placeholder="0"
                                    [required]="true"
                                    [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                    [tintColor]="nutrientFillColors.fiber"
                                    [textColor]="nutrientTextColors.fiber"
                                />
                            </div>

                            <fd-ui-nutrient-input
                                class="consumption-manage__nutrition-input consumption-manage__nutrition-input--alcohol"
                                formControlName="manualAlcohol"
                                type="number"
                                size="md"
                                icon="wine_bar"
                                variant="tinted"
                                valueAlign="left"
                                [labelUppercase]="false"
                                [label]="'PRODUCT_MANAGE.ALCOHOL' | translate"
                                placeholder="0"
                                [readonly]="consumptionForm.controls.isNutritionAutoCalculated.value"
                                [tintColor]="'rgba(148, 163, 184, 0.10)'"
                            />
                        </div>

                        @if (!consumptionForm.controls.isNutritionAutoCalculated.value) {
                            <p class="consumption-manage__nutrition-hint">
                                {{ 'CONSUMPTION_MANAGE.MANUAL_NUTRITION_HINT' | translate }}
                            </p>
                        }
                    </fd-ui-card>

                    <div class="consumption-manage__actions-panel">
                        <div class="consumption-manage__footer-actions">
                            <fd-ui-button
                                type="button"
                                fill="outline"
                                variant="primary"
                                icon="arrow_back"
                                (click)="onCancel()"
                            >
                                {{ 'PRODUCT_MANAGE.CANCEL_BUTTON' | translate }}
                            </fd-ui-button>
                            @if (consumption()) {
                                <fd-ui-button
                                    type="submit"
                                    class="consumption-manage__action-button"
                                    icon="save"
                                    [fullWidth]="true"
                                >
                                    {{ 'CONSUMPTION_MANAGE.SAVE_BUTTON' | translate }}
                                </fd-ui-button>
                            } @else {
                                <fd-ui-button
                                    type="submit"
                                    class="consumption-manage__action-button consumption-manage__action-button--add"
                                    icon="add"
                                    [fullWidth]="true"
                                >
                                    {{ 'CONSUMPTION_MANAGE.ADD_BUTTON' | translate }}
                                </fd-ui-button>
                            }
                        </div>
                        @if (globalError()) {
                            <fd-ui-form-error class="consumption-manage__footer-error" [error]="globalError()" />
                        }
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


