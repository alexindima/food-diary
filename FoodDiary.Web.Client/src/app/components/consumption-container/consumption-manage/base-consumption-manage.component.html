<div class="consumption-manage">
    <fd-page-header
        class="consumption-manage__header"
        [title]="consumption() ? ('CONSUMPTION_MANAGE.EDIT_TITLE' | translate) : ('CONSUMPTION_MANAGE.ADD_TITLE' | translate)"
    />

    <form class="consumption-manage__form" [formGroup]="consumptionForm" (ngSubmit)="onSubmit()">
        <div class="consumption-manage__grid">
            <div class="consumption-manage__column consumption-manage__column--primary">
                <fd-ui-card class="consumption-manage__card" [title]="'CONSUMPTION_MANAGE.GENERAL_GROUP_TITLE' | translate">
                    <div class="consumption-manage__basic-grid consumption-manage__basic-grid--dates">
                        <div class="consumption-manage__field">
                            <fd-ui-input formControlName="date"
                                type="datetime-local"
                                [label]="('CONSUMPTION_MANAGE.CHOOSE_DATE' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('date')"
                             />
                        </div>
                        <div class="consumption-manage__field">
                            <fd-ui-select formControlName="mealType"
                                [label]="'CONSUMPTION_MANAGE.MEAL_TYPE_LABEL' | translate"
                                [placeholder]="'CONSUMPTION_MANAGE.MEAL_TYPE_PLACEHOLDER' | translate"
                                [options]="mealTypeSelectOptions"
                                [error]="getControlError('mealType')"
                             />
                        </div>
                        <div class="consumption-manage__field consumption-manage__field--full">
                            <fd-ui-textarea formControlName="comment"
                                [label]="'CONSUMPTION_MANAGE.COMMENT' | translate"
                                [placeholder]="'CONSUMPTION_MANAGE.COMMENT_PLACEHOLDER' | translate"
                                [rows]="3"
                             />
                        </div>
                    </div>
                </fd-ui-card>

                <fd-ui-card
                    class="consumption-manage__card"
                    [title]="'CONSUMPTION_MANAGE.SATIETY_SECTION_TITLE' | translate"
                >
                    <p class="consumption-manage__satiety-note">
                        {{ 'CONSUMPTION_MANAGE.SATIETY_SECTION_HINT' | translate }}
                    </p>
                    <div class="consumption-manage__satiety-grid">
                        <div class="consumption-manage__satiety-field">
                            <p class="consumption-manage__satiety-picker-label">
                                {{ 'CONSUMPTION_MANAGE.HUNGER_BEFORE_LABEL' | translate }}
                            </p>
                            @let beforeMeta = getSatietyLevelMeta(consumptionForm.controls.preMealSatietyLevel.value);
                            <button
                                type="button"
                                class="consumption-manage__satiety-card"
                                (click)="openSatietyDialog('preMealSatietyLevel')"
                                [style.--satiety-gradient]="beforeMeta.gradient"
                            >
                                <div class="consumption-manage__satiety-card-indicator">
                                    {{
                                        (consumptionForm.controls.preMealSatietyLevel.value ?? 0) > 0
                                            ? consumptionForm.controls.preMealSatietyLevel.value
                                            : '?'
                                    }}
                                </div>
                                <div class="consumption-manage__satiety-card-text">
                                    <span class="consumption-manage__satiety-card-title">
                                        {{ beforeMeta.label }}
                                    </span>
                                    <span class="consumption-manage__satiety-card-description">
                                        {{ beforeMeta.description }}
                                    </span>
                                </div>
                                <mat-icon>tune</mat-icon>
                            </button>
                        </div>
                        <div class="consumption-manage__satiety-field">
                            <p class="consumption-manage__satiety-picker-label">
                                {{ 'CONSUMPTION_MANAGE.HUNGER_AFTER_LABEL' | translate }}
                            </p>
                            @let afterMeta = getSatietyLevelMeta(consumptionForm.controls.postMealSatietyLevel.value);
                            <button
                                type="button"
                                class="consumption-manage__satiety-card"
                                (click)="openSatietyDialog('postMealSatietyLevel')"
                                [style.--satiety-gradient]="afterMeta.gradient"
                            >
                                <div class="consumption-manage__satiety-card-indicator">
                                    {{
                                        (consumptionForm.controls.postMealSatietyLevel.value ?? 0) > 0
                                            ? consumptionForm.controls.postMealSatietyLevel.value
                                            : '?'
                                    }}
                                </div>
                                <div class="consumption-manage__satiety-card-text">
                                    <span class="consumption-manage__satiety-card-title">
                                        {{ afterMeta.label }}
                                    </span>
                                    <span class="consumption-manage__satiety-card-description">
                                        {{ afterMeta.description }}
                                    </span>
                                </div>
                                <mat-icon>tune</mat-icon>
                            </button>
                        </div>
                    </div>
                </fd-ui-card>

                <section class="consumption-manage__items-section">
                    <div class="consumption-manage__items-header">
                        <h3 class="consumption-manage__section-title">
                            {{ 'CONSUMPTION_MANAGE.ITEMS_GROUP_TITLE' | translate }}
                        </h3>
                        <div class="consumption-item__actions">
                            <fd-ui-button
                                type="button"
                                icon="add"
                                (click)="addConsumptionItem()"
                            >
                                {{ 'CONSUMPTION_MANAGE.ADD_ITEM' | translate }}
                            </fd-ui-button>
                            <fd-ui-button
                                type="button"
                                icon="photo_camera"
                                variant="primary"
                                fill="outline"
                                (click)="onAddConsumptionFromPhoto()"
                            >
                                {{ 'CONSUMPTION_MANAGE.ADD_ITEM_FROM_PHOTO' | translate }}
                            </fd-ui-button>
                        </div>
                    </div>
                    <div class="consumption-items" formArrayName="items">
                        @for (item of items.controls; track item; let i = $index; let first = $first) {
                            <fd-ui-card
                                class="consumption-item-card"
                                [subtle]="true"
                                appearance="entry"
                            >
                                <div class="consumption-item-card__header">
                                    <div class="consumption-item-card__title-wrapper">
                                        <span class="consumption-item-card__title">
                                            {{ getItemCardTitle(i) }}
                                        </span>
                                        @if (getItemCardMeta(i); as itemMeta) {
                                            <span class="consumption-item-card__meta">
                                                {{ itemMeta }}
                                            </span>
                                        }
                                    </div>
                                    <fd-ui-button
                                        type="button"
                                        variant="danger"
                                        fill="text"
                                        icon="close"
                                        [ariaLabel]="'CONSUMPTION_MANAGE.REMOVE_ITEM' | translate"
                                        class="consumption-item__remove"
                                        [disabled]="first"
                                        (click)="removeItem(i)"
                                    >
                                        {{ 'CONSUMPTION_MANAGE.REMOVE_ITEM' | translate }}
                                    </fd-ui-button>
                                </div>
                                <div class="consumption-item" [formGroupName]="i">
                                    <div class="consumption-item__fields">
                                        <div class="consumption-item__row">
                                            <div class="consumption-item__field consumption-item__field--source">
                                                <button
                                                    type="button"
                                                    class="consumption-item__selector"
                                                    [class.consumption-item__selector--invalid]="isItemSourceInvalid(i)"
                                                    (click)="onItemSourceClick(i)"
                                                >
                                                    <span class="consumption-item__selector-value">
                                                        {{
                                                            getItemSourceName(i)
                                                                || ('CONSUMPTION_MANAGE.ITEM_SOURCE_PLACEHOLDER' | translate)
                                                        }}
                                                    </span>
                                                    <mat-icon>search</mat-icon>
                                                </button>
                                                <fd-ui-form-error [error]="getItemSourceError(i)" />
                                            </div>
                                            <div class="consumption-item__field consumption-item__field--amount">
                                                <fd-ui-input formControlName="amount"
                                                    type="number"
                                                    [step]="0.01"
                                                    [label]="('CONSUMPTION_MANAGE.ADD_ITEM_ROW.AMOUNT' | translate) + '*'"
                                                    [placeholder]="(getAmountPlaceholder(i) | translate)"
                                                    [hint]="getAmountUnitLabel(i) || undefined"
                                                    [required]="true"
                                                    [error]="getAmountControlError(i)"
                                                    [readonly]="!items.at(i).controls.product.value && !items.at(i).controls.recipe.value"
                                                 />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fd-ui-card>
                        }
                    </div>
                    <fd-ui-form-error class="consumption-item__error"
                        [error]="items.invalid && items.touched ? ('FORM_ERRORS.NON_EMPTY_ARRAY' | translate) : null"
                     />
                </section>
            </div>

            <div class="consumption-manage__column consumption-manage__column--secondary">
                <fd-ui-card
                    class="consumption-manage__card consumption-manage__manual-card"
                    [title]="'CONSUMPTION_MANAGE.MANUAL_NUTRITION_TITLE' | translate"
                >
                    <fd-ui-checkbox formControlName="isNutritionAutoCalculated"
                        [label]="'CONSUMPTION_MANAGE.MANUAL_NUTRITION_AUTO' | translate"
                     />
                    @if (!consumptionForm.controls.isNutritionAutoCalculated.value) {
                        <p class="consumption-manage__nutrition-hint">
                            {{ 'CONSUMPTION_MANAGE.MANUAL_NUTRITION_HINT' | translate }}
                        </p>
                        <div class="consumption-manage__manual-grid">
                            <fd-ui-input formControlName="manualCalories"
                                type="number"
                                [label]="('CONSUMPTION_MANAGE.MANUAL_CALORIES' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('manualCalories')"
                             />
                            <fd-ui-input formControlName="manualFiber"
                                type="number"
                                [label]="('CONSUMPTION_MANAGE.MANUAL_FIBER' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('manualFiber')"
                             />
                            <fd-ui-input formControlName="manualProteins"
                                type="number"
                                [label]="('CONSUMPTION_MANAGE.MANUAL_PROTEINS' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('manualProteins')"
                             />
                            <fd-ui-input formControlName="manualFats"
                                type="number"
                                [label]="('CONSUMPTION_MANAGE.MANUAL_FATS' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('manualFats')"
                             />
                            <fd-ui-input formControlName="manualCarbs"
                                type="number"
                                [label]="('CONSUMPTION_MANAGE.MANUAL_CARBS' | translate) + '*'"
                                [required]="true"
                                [error]="getControlError('manualCarbs')"
                             />
                        </div>
                    }
                </fd-ui-card>
                <fd-ui-card
                    class="consumption-manage__card consumption-manage__card--sticky"
                    [title]="'CONSUMPTION_MANAGE.SUMMARY_TITLE' | translate"
                >
                    <p class="consumption-manage__summary-calories">
                        {{ 'CONSUMPTION_MANAGE.TOTAL_CALORIES' | translate }}:
                        <strong>{{ totalCalories() | number:'1.0-2' }} {{ 'PRODUCT_LIST.KCAL' | translate }}</strong>
                    </p>
                    <fd-nutrients-summary [bare]="true"
                        [calories]="totalCalories()"
                        [nutrientChartData]="nutrientChartData()"
                        [fiberValue]="totalFiber()"
                     />
                </fd-ui-card>
            </div>
        </div>

        <div class="consumption-manage__footer">
            <div class="consumption-manage__footer-actions">
                <fd-ui-button
                    type="button"
                    fill="outline"
                    variant="primary"
                    icon="arrow_back"
                    (click)="onCancel()"
                >
                    {{ 'PRODUCT_MANAGE.CANCEL_BUTTON' | translate }}
                </fd-ui-button>
                @if (consumption()) {
                    <fd-ui-button
                        type="submit"
                        class="consumption-manage__action-button"
                        icon="save"
                    >
                        {{ 'CONSUMPTION_MANAGE.SAVE_BUTTON' | translate }}
                    </fd-ui-button>
                } @else {
                    <fd-ui-button
                        type="submit"
                        class="consumption-manage__action-button"
                        icon="add"
                    >
                        {{ 'CONSUMPTION_MANAGE.ADD_BUTTON' | translate }}
                    </fd-ui-button>
                }
            </div>
            <fd-ui-form-error class="consumption-manage__footer-error" [error]="globalError()" />
        </div>
    </form>
</div>

