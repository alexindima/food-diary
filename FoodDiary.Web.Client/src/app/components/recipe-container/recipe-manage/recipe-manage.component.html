<div class="recipe-manage" fdPageContainer>
  <fd-page-header
    class="recipe-manage__header"
    [title]="recipe() ? ('RECIPE_MANAGE.EDIT_TITLE' | translate) : ('RECIPE_MANAGE.ADD_TITLE' | translate)"
    [subtitle]="'RECIPE_MANAGE.SUBTITLE' | translate"
  />

  <form class="recipe-manage__form" [formGroup]="recipeForm" (ngSubmit)="onSubmit()">
    @if (globalError()) {
      <div class="recipe-manage__error">
        {{ globalError() }}
      </div>
    }

    <div class="recipe-manage__grid">
      <div class="recipe-manage__column recipe-manage__column--primary">
        <fd-ui-card
          class="recipe-manage__card recipe-manage__card--general"
          appearance="entry"
          [title]="'RECIPE_MANAGE.GENERAL_GROUP_TITLE' | translate"
        >

          <div class="recipe-manage__hero-row">
            <div class="recipe-manage__image">
              <fd-image-upload-field
                formControlName="imageUrl"
                [description]="'RECIPE_MANAGE.IMAGE_HINT' | translate"
                [recommendedSize]="'512 x 512'"
                [maxSizeMb]="10"
                [acceptedTypes]="'image/png,image/jpeg,image/webp'"
                [cropEnabled]="true"
                [cropSize]="512"
                [cropAspectRatio]="1"
              />
            </div>
            <div class="recipe-manage__hero-fields">
              <fd-ui-input
                formControlName="name"
                size="lg"
                [label]="'RECIPE_MANAGE.NAME' | translate"
                [placeholder]="'RECIPE_MANAGE.NAME_PLACEHOLDER' | translate"
                [required]="true"
                [error]="getFieldError('name')"
               />

              <fd-ui-input formControlName="category"
                [label]="'RECIPE_MANAGE.CATEGORY' | translate"
                [placeholder]="'RECIPE_MANAGE.CATEGORY_PLACEHOLDER' | translate"
               />

              <fd-ui-input formControlName="cookTime"
                type="number"
                [step]="1"
                [label]="'RECIPE_MANAGE.COOK_TIME' | translate"
                [required]="true"
                [error]="getFieldError('cookTime')"
               />
            </div>
          </div>

          <div class="recipe-manage__basic-grid">
            <fd-ui-input formControlName="prepTime"
              type="number"
              [step]="1"
              [label]="'RECIPE_MANAGE.PREP_TIME' | translate"
              [required]="true"
              [error]="getFieldError('prepTime')"
             />

            <fd-ui-input formControlName="servings"
              type="number"
              [step]="1"
              [label]="'RECIPE_MANAGE.SERVINGS' | translate"
              [required]="true"
              [error]="getFieldError('servings')"
             />

            <fd-ui-select class="recipe-manage__field--full"
              formControlName="visibility"
              [label]="'RECIPE_MANAGE.VISIBILITY' | translate"
              [required]="true"
              [options]="visibilitySelectOptions"
              [error]="getFieldError('visibility')"
             />

            <fd-ui-textarea class="recipe-manage__field--full"
              formControlName="description"
              [label]="'RECIPE_MANAGE.DESCRIPTION' | translate"
              [placeholder]="'RECIPE_MANAGE.DESCRIPTION_PLACEHOLDER' | translate"
              [rows]="3"
              [maxlength]="1000"
              [error]="getFieldError('description')"
             />
          </div>
        </fd-ui-card>

        <fd-ui-card
          class="recipe-manage__card recipe-manage__card--steps"
          appearance="entry"
          [title]="'RECIPE_MANAGE.STEPS_TITLE' | translate"
        >

          <section class="recipe-manage__steps-section" formArrayName="steps">
            <div class="recipe-manage__steps" #dragBoundary fdDropZone>
              @for (step of steps.controls; track step; let index = $index; let first = $first) {
                <div
                  class="recipe-step"
                  [formGroupName]="index"
                  fdDraggable
                  [fdDraggableDragView]="customDragView"
                  [fdDraggablePlaceholder]="customDragPlaceholder"
                  [fdDraggableAxis]="'Y'"
                  [fdDraggableBoundary]="dragBoundary"
                  >
                  <fd-ui-card
                    class="recipe-step-card"
                    [subtle]="true"
                    >
                    <div class="recipe-step-card__header" fdDragHandle>
                      <span class="recipe-step-card__title">
                        {{ 'RECIPE_MANAGE.STEP_TITLE' | translate : { index: index + 1 } }}
                      </span>
                      <fd-ui-button
                        type="button"
                        variant="danger"
                        fill="text"
                        icon="delete"
                        [disabled]="first"
                        (click)="removeStep(index)"
                        >
                        {{ 'RECIPE_MANAGE.REMOVE_STEP' | translate }}
                      </fd-ui-button>
                    </div>

                    <fd-ui-textarea formControlName="description"
                      [rows]="3"
                      [label]="'RECIPE_MANAGE.STEP_DESCRIPTION' | translate"
                      [placeholder]="'RECIPE_MANAGE.STEP_DESCRIPTION_PLACEHOLDER' | translate"
                      [error]="getStepDescriptionError(index)"
                     />

                    <div class="recipe-step-card__ingredients" formArrayName="ingredients">
                      @for (ingredient of getStepIngredients(index).controls; track ingredient; let ingredientIndex = $index; let firstIngredient = $first) {
                        <div class="recipe-ingredient" [formGroupName]="ingredientIndex">
                          <input type="hidden" formControlName="food" />
                          <fd-ui-input class="recipe-ingredient__name"
                            formControlName="foodName"
                            [label]="'RECIPE_MANAGE.INGREDIENT_NAME' | translate"
                            [placeholder]="'RECIPE_MANAGE.INGREDIENT_NAME_PLACEHOLDER' | translate"
                            [readonly]="true"
                            suffixButtonIcon="search"
                            [suffixButtonAriaLabel]="'RECIPE_MANAGE.SELECT_INGREDIENT' | translate"
                            (suffixButtonClicked)="onProductSelectClick(index, ingredientIndex)"
                            (click)="onProductSelectClick(index, ingredientIndex)"
                            [error]="getIngredientControlError(index, ingredientIndex, 'food')"
                           />

                          <div class="recipe-ingredient__amount">
                            <fd-ui-input formControlName="amount"
                              type="number"
                              [step]="0.01"
                              [label]="getIngredientAmountLabel(index, ingredientIndex)"
                              [error]="getIngredientControlError(index, ingredientIndex, 'amount')"
                             />
                            <fd-ui-button type="button"
                              variant="danger"
                              fill="text"
                              icon="delete"
                              [disabled]="firstIngredient"
                              (click)="removeIngredientFromStep(index, ingredientIndex)"
                             />
                          </div>
                        </div>
                      }

                      <fd-ui-button
                        type="button"
                        icon="add"
                        variant="primary"
                        fill="outline"
                        (click)="addIngredientToStep(index)"
                        >
                        {{ 'RECIPE_MANAGE.ADD_INGREDIENT' | translate }}
                      </fd-ui-button>
                    </div>
                  </fd-ui-card>
                </div>
              }
            </div>
            <fd-ui-button
              type="button"
              icon="add"
              variant="primary"
              (click)="addStep()"
              >
              {{ 'RECIPE_MANAGE.ADD_STEP' | translate }}
            </fd-ui-button>
            @if (steps.invalid && steps.touched) {
              <div class="recipe-manage__array-error">
                {{ 'FORM_ERRORS.NON_EMPTY_ARRAY' | translate }}
              </div>
            }
          </section>
        </fd-ui-card>
      </div>

      <div class="recipe-manage__column recipe-manage__column--secondary">
        <div class="recipe-manage__sticky-stack">
          <fd-ui-card
            class="recipe-manage__card recipe-manage__card--facts"
            appearance="entry"
            [title]="'RECIPE_MANAGE.NUTRITION_GROUP_TITLE' | translate"
          >
            <div class="recipe-manage__calories-header">
              <fd-ui-checkbox formControlName="calculateNutritionAutomatically"
                class="recipe-manage__calories-toggle"
                [label]="'RECIPE_MANAGE.AUTO_NUTRITION_LABEL' | translate"
               />
            </div>

            <div class="recipe-manage__nutrition-grid">
              <div class="recipe-manage__calories-input">
                <label class="recipe-manage__input-label" for="recipeCaloriesInput">
                  {{ 'RECIPE_MANAGE.MANUAL_CALORIES' | translate }}
                </label>
                <div class="recipe-manage__input-field recipe-manage__input-field--calories">
                  <input
                    id="recipeCaloriesInput"
                    class="recipe-manage__input recipe-manage__input--calories"
                    type="number"
                    step="1"
                    formControlName="manualCalories"
                    [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                    inputmode="decimal"
                  />
                  <span class="recipe-manage__input-unit">{{ 'GENERAL.UNITS.KCAL' | translate }}</span>
                </div>
                @if (getFieldError('manualCalories')) {
                  <div class="recipe-manage__input-error">{{ getFieldError('manualCalories') }}</div>
                }
              </div>

              <div class="recipe-manage__facts-grid">
                <fd-ui-accent-surface
                  class="recipe-manage__macro-card"
                  accentSide="top"
                  [accentColor]="chartColors.proteins"
                  [tinted]="true"
                >
                  <div class="recipe-manage__fact-label">{{ 'NUTRIENTS.PROTEINS' | translate }}</div>
                  <div class="recipe-manage__input-field recipe-manage__input-field--macro">
                    <input
                      class="recipe-manage__input recipe-manage__input--macro"
                      type="number"
                      step="0.1"
                      formControlName="manualProteins"
                      [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                      inputmode="decimal"
                    />
                    <span class="recipe-manage__input-unit">{{ 'PRODUCT_AMOUNT_UNITS_SHORT.G' | translate }}</span>
                  </div>
                  @if (getFieldError('manualProteins')) {
                    <div class="recipe-manage__input-error">{{ getFieldError('manualProteins') }}</div>
                  }
                </fd-ui-accent-surface>

                <fd-ui-accent-surface
                  class="recipe-manage__macro-card"
                  accentSide="top"
                  [accentColor]="chartColors.fats"
                  [tinted]="true"
                >
                  <div class="recipe-manage__fact-label">{{ 'NUTRIENTS.FATS' | translate }}</div>
                  <div class="recipe-manage__input-field recipe-manage__input-field--macro">
                    <input
                      class="recipe-manage__input recipe-manage__input--macro"
                      type="number"
                      step="0.1"
                      formControlName="manualFats"
                      [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                      inputmode="decimal"
                    />
                    <span class="recipe-manage__input-unit">{{ 'PRODUCT_AMOUNT_UNITS_SHORT.G' | translate }}</span>
                  </div>
                  @if (getFieldError('manualFats')) {
                    <div class="recipe-manage__input-error">{{ getFieldError('manualFats') }}</div>
                  }
                </fd-ui-accent-surface>

                <fd-ui-accent-surface
                  class="recipe-manage__macro-card"
                  accentSide="top"
                  [accentColor]="chartColors.carbs"
                  [tinted]="true"
                >
                  <div class="recipe-manage__fact-label">{{ 'NUTRIENTS.CARBS' | translate }}</div>
                  <div class="recipe-manage__input-field recipe-manage__input-field--macro">
                    <input
                      class="recipe-manage__input recipe-manage__input--macro"
                      type="number"
                      step="0.1"
                      formControlName="manualCarbs"
                      [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                      inputmode="decimal"
                    />
                    <span class="recipe-manage__input-unit">{{ 'PRODUCT_AMOUNT_UNITS_SHORT.G' | translate }}</span>
                  </div>
                  @if (getFieldError('manualCarbs')) {
                    <div class="recipe-manage__input-error">{{ getFieldError('manualCarbs') }}</div>
                  }
                </fd-ui-accent-surface>

                <fd-ui-accent-surface
                  class="recipe-manage__macro-card"
                  accentSide="top"
                  [accentColor]="chartColors.fiber"
                  [tinted]="true"
                >
                  <div class="recipe-manage__fact-label">{{ 'NUTRIENTS.FIBER' | translate }}</div>
                  <div class="recipe-manage__input-field recipe-manage__input-field--macro">
                    <input
                      class="recipe-manage__input recipe-manage__input--macro"
                      type="number"
                      step="0.1"
                      formControlName="manualFiber"
                      [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                      inputmode="decimal"
                    />
                    <span class="recipe-manage__input-unit">{{ 'PRODUCT_AMOUNT_UNITS_SHORT.G' | translate }}</span>
                  </div>
                  @if (getFieldError('manualFiber')) {
                    <div class="recipe-manage__input-error">{{ getFieldError('manualFiber') }}</div>
                  }
                </fd-ui-accent-surface>

                <fd-ui-accent-surface
                  class="recipe-manage__macro-card"
                  accentSide="top"
                  [accentColor]="chartColors.alcohol"
                  [tinted]="true"
                >
                  <div class="recipe-manage__fact-label">{{ 'NUTRIENTS.ALCOHOL' | translate }}</div>
                  <div class="recipe-manage__input-field recipe-manage__input-field--macro">
                    <input
                      class="recipe-manage__input recipe-manage__input--macro"
                      type="number"
                      step="0.1"
                      formControlName="manualAlcohol"
                      [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                      inputmode="decimal"
                    />
                    <span class="recipe-manage__input-unit">{{ 'PRODUCT_AMOUNT_UNITS_SHORT.G' | translate }}</span>
                  </div>
                  @if (getFieldError('manualAlcohol')) {
                    <div class="recipe-manage__input-error">{{ getFieldError('manualAlcohol') }}</div>
                  }
                </fd-ui-accent-surface>
              </div>
            </div>

            @if (!recipeForm.controls.calculateNutritionAutomatically.value) {
              <p class="recipe-manage__nutrition-hint">
                {{ 'RECIPE_MANAGE.MANUAL_NUTRITION_HINT' | translate }}
              </p>
            }

            @if (nutritionWarning(); as warning) {
              <div class="recipe-manage__nutrition-warning">
                {{ 'PRODUCT_MANAGE.CALORIES_MISMATCH_WARNING' | translate: {
                  expected: warning.expectedCalories,
                  actual: warning.actualCalories
                } }}
              </div>
            }
          </fd-ui-card>

        </div>
      </div>
    </div>

    <div class="recipe-manage__footer">
      <div class="recipe-manage__footer-actions">
        <fd-ui-button
          type="button"
          variant="secondary"
          fill="outline"
          icon="arrow_back"
          (click)="onCancel()"
          >
          {{ 'PRODUCT_MANAGE.CANCEL_BUTTON' | translate }}
        </fd-ui-button>
        <fd-ui-button
          type="submit"
          class="recipe-manage__action-button"
          icon="save"
          [disabled]="recipeForm.invalid || isSubmitting()"
          >
          {{ recipe() ? ('RECIPE_MANAGE.SAVE_BUTTON' | translate) : ('RECIPE_MANAGE.ADD_BUTTON' | translate) }}
        </fd-ui-button>
      </div>
    </div>
  </form>
</div>

<ng-template #customDragView>
  <fd-ui-card class="recipe-manage__drag-card" [subtle]="true">
    {{ 'RECIPE_MANAGE.DRAGGING_HINT' | translate }}
  </fd-ui-card>
</ng-template>

<ng-template #customDragPlaceholder>
  <div class="recipe-manage__drag-placeholder">
    {{ 'RECIPE_MANAGE.DRAGGING_PLACEHOLDER' | translate }}
  </div>
</ng-template>
