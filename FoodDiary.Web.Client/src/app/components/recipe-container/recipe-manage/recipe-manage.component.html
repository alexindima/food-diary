<div class="recipe-manage" fdPageContainer>
  <fd-page-header
    class="recipe-manage__header"
    [title]="recipe() ? ('RECIPE_MANAGE.EDIT_TITLE' | translate) : ('RECIPE_MANAGE.ADD_TITLE' | translate)"
    [subtitle]="'RECIPE_MANAGE.SUBTITLE' | translate"
  />

  <form class="recipe-manage__form" [formGroup]="recipeForm" (ngSubmit)="onSubmit()">
    @if (globalError()) {
      <div class="recipe-manage__error">
        {{ globalError() }}
      </div>
    }

    <div class="recipe-manage__grid">
      <div class="recipe-manage__column recipe-manage__column--primary">
        <fd-ui-card
          class="recipe-manage__card recipe-manage__card--basic"
          appearance="entry"
          [title]="'RECIPE_MANAGE.GENERAL_GROUP_TITLE' | translate"
        >
          <div class="recipe-manage__hero">
            <div class="recipe-manage__image">
              <fd-image-upload-field
                formControlName="imageUrl"
                [description]="'RECIPE_MANAGE.IMAGE_HINT' | translate"
                [recommendedSize]="'512 x 512'"
                [maxSizeMb]="10"
                [acceptedTypes]="'image/png,image/jpeg,image/webp'"
                [cropEnabled]="true"
                [cropSize]="512"
                [cropAspectRatio]="1"
              />
            </div>
            <div class="recipe-manage__hero-field">
              <fd-ui-input
                formControlName="name"
                size="lg"
                [label]="'RECIPE_MANAGE.NAME' | translate"
                [placeholder]="'RECIPE_MANAGE.NAME_PLACEHOLDER' | translate"
                [required]="true"
                [error]="getFieldError('name')"
               />
            </div>
            <div class="recipe-manage__hero-field">
              <fd-ui-input
                formControlName="category"
                size="lg"
                [label]="'RECIPE_MANAGE.CATEGORY' | translate"
                [placeholder]="'RECIPE_MANAGE.CATEGORY_PLACEHOLDER' | translate"
               />
            </div>
            <div class="recipe-manage__hero-field">
              <fd-ui-input
                formControlName="cookTime"
                type="number"
                [step]="1"
                size="lg"
                [label]="'RECIPE_MANAGE.COOK_TIME' | translate"
                [required]="true"
                [error]="getFieldError('cookTime')"
               />
            </div>
          </div>

          <div class="recipe-manage__basic-grid">
            <fd-ui-input
              formControlName="prepTime"
              type="number"
              [step]="1"
              [label]="'RECIPE_MANAGE.PREP_TIME' | translate"
              [error]="getFieldError('prepTime')"
             />

            <fd-ui-input
              formControlName="servings"
              type="number"
              [step]="1"
              [label]="'RECIPE_MANAGE.SERVINGS' | translate"
              [required]="true"
              [error]="getFieldError('servings')"
             />

            <fd-ui-textarea class="recipe-manage__field--full"
              formControlName="description"
              [label]="'RECIPE_MANAGE.DESCRIPTION' | translate"
              [placeholder]="'RECIPE_MANAGE.DESCRIPTION_PLACEHOLDER' | translate"
              [rows]="3"
              [maxlength]="1000"
              [error]="getFieldError('description')"
             />
          </div>
        </fd-ui-card>

        <fd-ui-card
          class="recipe-manage__card recipe-manage__card--basic recipe-manage__card--tracking"
          appearance="entry"
          [title]="'RECIPE_MANAGE.TRACKING_PREFERENCES' | translate"
        >
          <div class="recipe-manage__basic-grid">
            <div class="recipe-manage__field recipe-manage__field--full">
              <fd-ui-select
                formControlName="visibility"
                [label]="'RECIPE_MANAGE.VISIBILITY' | translate"
                [required]="true"
                [options]="visibilitySelectOptions"
                [error]="getFieldError('visibility')"
               />
            </div>
            <div class="recipe-manage__field recipe-manage__field--full">
              <fd-ui-textarea
                formControlName="comment"
                [label]="'RECIPE_MANAGE.COMMENT' | translate"
                [placeholder]="'RECIPE_MANAGE.COMMENT_PLACEHOLDER' | translate"
                [rows]="4"
                [maxlength]="1000"
                [error]="getFieldError('comment')"
               />
            </div>
          </div>
        </fd-ui-card>

        <div class="recipe-manage__steps-block">
          <div class="recipe-manage__steps-title">
            {{ 'RECIPE_MANAGE.STEPS_SECTION_TITLE' | translate }}
          </div>
          <section class="recipe-manage__steps-section" formArrayName="steps">
            <div
              class="recipe-manage__steps"
              cdkDropList
              #dragBoundary
              [cdkDropListData]="steps.controls"
              (cdkDropListDropped)="onStepDrop($event)"
            >
              @for (step of steps.controls; track step; let index = $index; let first = $first) {
                <div
                  class="recipe-step"
                  [formGroupName]="index"
                  cdkDrag
                  [cdkDragDisabled]="steps.length <= 1"
                  [cdkDragBoundary]="dragBoundary"
                  cdkDragLockAxis="y"
                  >
                  <fd-ui-card
                    class="recipe-manage__card recipe-step-card"
                    >
                    <div class="recipe-step-card__header">
                      <div class="recipe-step-card__header-left">
                        <span
                          class="recipe-step-card__drag"
                          cdkDragHandle
                          [class.recipe-step-card__drag--disabled]="steps.length <= 1"
                          aria-hidden="true"
                        ></span>
                        @if (isStepTitleEditing(index)) {
                          <fd-ui-input
                            class="recipe-step-card__title-input"
                            formControlName="title"
                            [placeholder]="getStepTitleDisplay(index)"
                            (blur)="onStepTitleBlur(index)"
                           />
                        } @else {
                          <span class="recipe-step-card__title">
                            {{ getStepTitleDisplay(index) }}
                          </span>
                        }
                        <fd-ui-button
                          type="button"
                          variant="secondary"
                          fill="text"
                          icon="edit"
                          class="recipe-step-card__edit"
                          [attr.aria-label]="'RECIPE_MANAGE.EDIT_STEP_TITLE' | translate"
                          (click)="toggleStepTitleEdit(index)"
                          >
                        </fd-ui-button>
                      </div>
                      <div class="recipe-step-card__header-actions">
                        <fd-ui-button
                          type="button"
                          variant="secondary"
                          fill="text"
                          [icon]="isStepExpanded(index) ? 'expand_less' : 'expand_more'"
                          [attr.aria-label]="'RECIPE_MANAGE.TOGGLE_STEP' | translate"
                          (click)="toggleStepExpanded(index)"
                          >
                        </fd-ui-button>
                        <fd-ui-button
                          type="button"
                          variant="danger"
                          fill="text"
                          icon="delete"
                          [disabled]="first"
                          (click)="removeStep(index)"
                          >
                          {{ 'RECIPE_MANAGE.REMOVE_STEP' | translate }}
                        </fd-ui-button>
                      </div>
                    </div>

                    @if (!isStepExpanded(index)) {
                      <div class="recipe-step-card__summary">
                        <div class="recipe-step-card__summary-description">
                          {{ getStepDescriptionSummary(index) }}
                        </div>
                        <div class="recipe-step-card__summary-meta">
                          {{ 'RECIPE_MANAGE.STEP_INGREDIENTS_COUNT' | translate: { count: getStepIngredientsCount(index) } }}
                        </div>
                      </div>
                    }

                    @if (isStepExpanded(index)) {
                      <div class="recipe-step-card__content">
                        <div class="recipe-step-card__image">
                          <fd-image-upload-field
                            formControlName="imageUrl"
                            [description]="'RECIPE_MANAGE.STEP_IMAGE_HINT' | translate"
                            [recommendedSize]="'512 x 512'"
                            [maxSizeMb]="10"
                            [acceptedTypes]="'image/png,image/jpeg,image/webp'"
                            [cropEnabled]="true"
                            [cropSize]="512"
                            [cropAspectRatio]="1"
                          />
                        </div>
                        <div class="recipe-step-card__description">
                          <fd-ui-textarea formControlName="description"
                            [rows]="3"
                            [label]="'RECIPE_MANAGE.STEP_DESCRIPTION' | translate"
                            [placeholder]="'RECIPE_MANAGE.STEP_DESCRIPTION_PLACEHOLDER' | translate"
                            [error]="getStepDescriptionError(index)"
                           />
                        </div>
                      </div>

                      <div class="recipe-step-card__ingredients" formArrayName="ingredients">
                        <div class="recipe-step-card__subtitle">
                          {{ 'RECIPE_MANAGE.INGREDIENTS' | translate }}
                        </div>
                        @for (ingredient of getStepIngredients(index).controls; track ingredient; let ingredientIndex = $index; let firstIngredient = $first) {
                          <div class="recipe-ingredient" [formGroupName]="ingredientIndex">
                              <input type="hidden" formControlName="food" />
                              <input type="hidden" formControlName="nestedRecipeId" />
                              <fd-ui-input class="recipe-ingredient__name"
                                formControlName="foodName"
                                [label]="'RECIPE_MANAGE.INGREDIENT_NAME' | translate"
                                [placeholder]="'RECIPE_MANAGE.INGREDIENT_NAME_PLACEHOLDER' | translate"
                                [readonly]="true"
                                [prefixIcon]="getIngredientIcon(index, ingredientIndex)"
                                [ariaLabel]="'RECIPE_MANAGE.SELECT_INGREDIENT' | translate"
                                (click)="onProductSelectClick(index, ingredientIndex)"
                                [error]="getIngredientControlError(index, ingredientIndex, 'foodName')"
                               />

                            <div class="recipe-ingredient__amount">
                              <fd-ui-input formControlName="amount"
                                type="number"
                                [step]="0.01"
                                [label]="getIngredientAmountLabel(index, ingredientIndex)"
                                [error]="getIngredientControlError(index, ingredientIndex, 'amount')"
                               />
                              <fd-ui-button type="button"
                                variant="danger"
                                fill="text"
                                icon="delete"
                                [disabled]="firstIngredient"
                                (click)="removeIngredientFromStep(index, ingredientIndex)"
                               />
                            </div>
                          </div>
                        }

                        <fd-ui-button
                          type="button"
                          icon="add"
                          class="recipe-step-card__add-ingredient"
                          variant="secondary"
                          fill="outline"
                          (click)="addIngredientToStep(index)"
                          >
                          {{ 'RECIPE_MANAGE.ADD_INGREDIENT' | translate }}
                        </fd-ui-button>
                      </div>
                    }
                  </fd-ui-card>
                </div>
              }
            </div>
            <fd-ui-button
              type="button"
              icon="add"
              class="recipe-manage__add-step"
              variant="secondary"
              fill="outline"
              (click)="addStep()"
              >
              {{ 'RECIPE_MANAGE.ADD_STEP' | translate }}
            </fd-ui-button>
            @if (steps.invalid && steps.touched) {
              <div class="recipe-manage__array-error">
                {{ 'FORM_ERRORS.NON_EMPTY_ARRAY' | translate }}
              </div>
            }
          </section>
        </div>
      </div>

      <div class="recipe-manage__column recipe-manage__column--secondary">
        <div class="recipe-manage__sticky-stack">
          <fd-ui-card
            class="recipe-manage__card recipe-manage__card--facts"
            appearance="entry"
            [title]="'RECIPE_MANAGE.NUTRITION_GROUP_TITLE' | translate"
          >
            <div class="recipe-manage__nutrition">
              <fd-nutrition-editor
                [formGroup]="recipeForm"
                [controlNames]="nutritionControlNames"
                [macroState]="macroBarState()"
                [readonly]="recipeForm.controls.calculateNutritionAutomatically.value"
                [caloriesError]="caloriesError()"
                [macrosError]="macrosError()"
                [showManualHint]="!recipeForm.controls.calculateNutritionAutomatically.value"
                [manualHintKey]="'RECIPE_MANAGE.MANUAL_NUTRITION_HINT'"
                [warning]="nutritionWarning()"
              >
                <fd-ui-segmented-toggle
                  nutrition-before
                  class="recipe-manage__nutrition-toggle"
                  [options]="nutritionModeOptions"
                  [selectedValue]="nutritionMode"
                  (selectedValueChange)="onNutritionModeChange($event)"
                  [ariaLabel]="'RECIPE_MANAGE.NUTRITION_MODE.ARIA' | translate"
                />
                <fd-ui-segmented-toggle
                  nutrition-before
                  class="recipe-manage__nutrition-toggle"
                  [options]="nutritionScaleModeOptions"
                  [selectedValue]="nutritionScaleMode"
                  (selectedValueChange)="onNutritionScaleModeChange($event)"
                  [ariaLabel]="'RECIPE_MANAGE.NUTRITION_SCALE_MODE.ARIA' | translate"
                />
              </fd-nutrition-editor>
            </div>
          </fd-ui-card>

          <div class="recipe-manage__actions-panel">
            <div class="recipe-manage__footer-actions">
              <fd-ui-button
                type="button"
                variant="secondary"
                fill="outline"
                icon="arrow_back"
                (click)="onCancel()"
                >
                {{ 'PRODUCT_MANAGE.CANCEL_BUTTON' | translate }}
              </fd-ui-button>
              <fd-ui-button
                type="submit"
                class="recipe-manage__action-button recipe-manage__action-button--add"
                icon="save"
                [fullWidth]="true"
                [disabled]="recipeForm.invalid || isSubmitting()"
                >
                {{ recipe() ? ('RECIPE_MANAGE.SAVE_BUTTON' | translate) : ('RECIPE_MANAGE.ADD_BUTTON' | translate) }}
              </fd-ui-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

