<div class="dashboard" fdPageContainer>
    <fd-page-header
        class="dashboard__header"
        [title]="
            isTodaySelected()
                ? ('DASHBOARD.TITLE' | translate)
                : ('DASHBOARD.TITLE_FOR_DATE' | translate:{ date: (selectedDate() | localizedDate:'d MMMM y') })
        "
        [subtitle]="'DASHBOARD.SUBTITLE' | translate"
    >
        <ng-container fdPageHeaderActions>
            <div>
                <mat-form-field class="dashboard__date-field" appearance="outline">
                    <input
                        matInput
                        [matDatepicker]="headerDatePicker"
                        [value]="selectedDate()"
                        (dateChange)="handleDateChange($event)"
                    />
                </mat-form-field>
                <mat-datepicker #headerDatePicker />
                <fd-ui-button
                    class="dashboard__date-button"
                    variant="secondary"
                    fill="outline"
                    icon="calendar_today"
                    (click)="openDatePicker()"
                >
                    {{ selectedDate() | localizedDate:'d MMMM y' }}
                </fd-ui-button>
            </div>

            <fd-ui-button
                class="dashboard__primary-action"
                icon="add"
                (click)="addConsumption()"
            >
                {{ 'DASHBOARD.ACTIONS.ADD_CONSUMPTION_BUTTON' | translate }}
            </fd-ui-button>
        </ng-container>
    </fd-page-header>

    <fd-page-body>
        @if (isLoading()) {
            <div class="dashboard__loader">{{ 'DASHBOARD.LOADING' | translate }}</div>
        } @else {
            <section class="dashboard__grid">
                <div class="dashboard__key-metrics">
                    <fd-daily-progress-card
                        class="dashboard__card dashboard__card--progress"
                        [date]="selectedDate()"
                        [consumed]="todayCalories()"
                        [goal]="dailyGoal()"
                    />

                    <fd-macro-summary
                        class="dashboard__card dashboard__card--macros"
                        [nutrientData]="nutrientChartData()"
                        [fiber]="todayFiber() ?? 0"
                    />
                </div>

                <fd-motivation-card
                    class="dashboard__card dashboard__card--motivation dashboard__card--motivation-wide"
                    [consumed]="todayCalories()"
                    [goal]="dailyGoal()"
                />

                <div class="dashboard__insights">
                    <fd-weight-summary-card
                        class="dashboard__card dashboard__card--weight dashboard__card--clickable"
                        [latest]="latestWeightEntry()"
                        [previous]="previousWeightEntry()"
                        [desired]="desiredWeight()"
                        (cardClick)="openWeightHistory()"
                    />
                    <fd-ui-card
                        class="dashboard__card dashboard__card--waist dashboard__card--clickable"
                        role="button"
                        tabindex="0"
                        (click)="openWaistHistory()"
                        [title]="'DASHBOARD.WAIST_TITLE' | translate"
                        [meta]="waistMetaText()"
                    >
                        <div class="dashboard__weight-summary">
                            <strong class="dashboard__weight-value">
                                @if (latestWaistEntry()) {
                                    {{ latestWaistEntry()?.circumference | number:'1.0-1' }}
                                    {{ 'DASHBOARD.CM' | translate }}
                                } @else {
                                    {{ 'WAIST_HISTORY.NO_DATA' | translate }}
                                }
                            </strong>
                            <span class="dashboard__weight-trend">
                            {{ waistTrendLabel() }}
                        </span>
                        </div>
                    </fd-ui-card>
                    <fd-ui-card
                        class="dashboard__card dashboard__card--activity"
                        [title]="'DASHBOARD.ACTIVITY_TITLE' | translate"
                        [meta]="'DASHBOARD.ACTIVITY_META' | translate"
                    >
                        <div class="dashboard__activity-grid">
                            <div>
                                <p class="dashboard__activity-label">{{ 'DASHBOARD.CALORIES_BURNED' | translate }}</p>
                                <strong class="dashboard__activity-value">215 {{ 'PRODUCT_LIST.KCAL' | translate }}</strong>
                            </div>
                            <div>
                                <p class="dashboard__activity-label">{{ 'DASHBOARD.STEPS' | translate }}</p>
                                <strong class="dashboard__activity-value">5 420</strong>
                            </div>
                        </div>
                    </fd-ui-card>
                </div>
            </section>

            <section class="dashboard__meals">
                <div class="dashboard__section-header">
                    <div>
                        <h2 class="dashboard__section-title">{{ 'DASHBOARD.MEALS_TITLE' | translate }}</h2>
                    </div>
                    <fd-ui-button
                        variant="primary"
                        fill="text"
                        size="sm"
                        icon="open_in_new"
                        (click)="manageConsumptions()"
                    >
                        {{ 'DASHBOARD.MEALS_VIEW_ALL' | translate }}
                    </fd-ui-button>
                </div>

                @if (meals().length === 0) {
                    <div class="dashboard__empty">
                        {{ 'DASHBOARD.MEALS_EMPTY' | translate }}
                    </div>
                } @else {
                    <div class="dashboard__meal-list">
                        @for (meal of meals(); track meal.id) {
                            <fd-ui-entity-card
                                class="dashboard__meal-card consumption-card fd-ui-entity-card--hoverable"
                                appearance="info"
                                [imageUrl]="meal.imageUrl || undefined"
                                (click)="openConsumption(meal)"
                            >
                                <div class="product-card consumption-card__content">
                                    <div class="product-card__header">
                                        <div class="product-card__title">
                            <span class="product-card__name">
                                @if (meal.mealType) {
                                    {{ ('MEAL_TYPES.' + meal.mealType) | translate }}
                                } @else {
                                    {{ 'CONSUMPTION_LIST.DATE' | translate }}
                                }
                            </span>
                                        </div>
                                        <span class="product-card__barcode">
                            {{ meal.date | date:'dd.MM.yyyy' }} · {{ meal.date | date:'HH:mm' }}
                        </span>
                                    </div>
                                    <div class="product-card__stats">
                        <span class="product-card__calories">
                            {{ 'CONSUMPTION_LIST.TOTAL_CALORIES' | translate }}:
                            {{ meal.totalCalories | number: '1.0-2' }}
                            {{ 'PRODUCT_LIST.KCAL' | translate }}
                        </span>
                                        <span class="product-card__macros">
                            {{ 'PRODUCT_LIST.PROTEINS' | translate }}: {{ meal.totalProteins | number: '1.0-2' }}g ·
                                            {{ 'PRODUCT_LIST.FATS' | translate }}: {{ meal.totalFats | number: '1.0-2' }}g ·
                                            {{ 'PRODUCT_LIST.CARBS' | translate }}: {{ meal.totalCarbs | number: '1.0-2' }}g
                        </span>
                                    </div>
                                    <div class="consumption-card__meta">
                        <span class="consumption-card__count">
                            {{ 'CONSUMPTION_LIST.ITEM_COUNT' | translate }}: {{ meal.items.length }}
                        </span>
                                        @if (meal.comment) {
                                            <span class="consumption-card__comment">
                                {{ meal.comment }}
                            </span>
                                        }
                                    </div>
                                </div>
                            </fd-ui-entity-card>
                        }
                    </div>
                }
            </section>

            <section class="dashboard__quick-actions">
                <h2 class="dashboard__section-title">{{ 'DASHBOARD.QUICK_ACTIONS_TITLE' | translate }}</h2>
                <div class="dashboard__quick-actions-grid">
                    @for (action of quickActions; track action.buttonKey) {
                        <fd-ui-card class="dashboard__quick-card" [subtle]="true">
                            <div class="dashboard__quick-card-content">
                                <div class="dashboard__quick-card-icon">
                                    <mat-icon>{{ action.icon }}</mat-icon>
                                </div>
                                <div>
                                    <p class="dashboard__quick-card-title">{{ action.titleKey | translate }}</p>
                                    <span class="dashboard__quick-card-description">
                                {{ action.descriptionKey | translate }}
                            </span>
                                </div>
                            </div>
                            <fd-ui-button
                                [variant]="action.variant"
                                [fill]="action.fill"
                                [fullWidth]="true"
                                (click)="action.action()"
                            >
                                {{ action.buttonKey | translate }}
                            </fd-ui-button>
                        </fd-ui-card>
                    }
                </div>
            </section>
        }
    </fd-page-body>
</div>
