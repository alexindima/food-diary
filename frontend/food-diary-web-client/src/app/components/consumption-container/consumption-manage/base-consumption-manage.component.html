<div class="consumption-manage">
    <h2 class="consumption-manage__title">
        @if (consumption()) {
            {{ 'CONSUMPTION_MANAGE.EDIT_TITLE' | translate }}
        } @else {
            {{ 'CONSUMPTION_MANAGE.ADD_TITLE' | translate }}
        }
    </h2>

    <form class="consumption-manage__form" [formGroup]="consumptionForm" (ngSubmit)="onSubmit()">
        <div class="consumption-manage__date">
            <tui-input-date-time
                formControlName="date"
            >
                {{ 'CONSUMPTION_MANAGE.CHOOSE_DATE' | translate }}
            </tui-input-date-time>
            <tui-error
                formControlName="date"
                [error]="[] | tuiFieldError | async"
            ></tui-error>
        </div>
        <div class="consumption-manage__consumption">
            <fd-custom-group
                [title]="'CONSUMPTION_MANAGE.ITEMS_GROUP_TITLE' | translate"
            >
                <div class="consumption-manage__items" formArrayName="items">
                    @for (item of items.controls; track item; let i = $index; let first = $first) {
                        <div class="consumption-manage__item" [formGroupName]="i">
                            <div class="consumption-manage__item-header">
                                <tui-select
                                    class="consumption-manage__item-type"
                                    formControlName="sourceType"
                                    [stringify]="stringifySourceType"
                                    (tuiValueChange)="onItemTypeChange(i, $event)"
                                    [tuiTextfieldLabelOutside]="true"
                                >
                                    {{ 'CONSUMPTION_MANAGE.ITEM_TYPE_LABEL' | translate }}
                                    <ng-template tuiDataList>
                                        @for (option of sourceTypeOptions; track option) {
                                            <button tuiOption [value]="option">
                                                {{ ('CONSUMPTION_MANAGE.ITEM_TYPE_OPTIONS.' + option) | translate }}
                                            </button>
                                        }
                                    </ng-template>
                                </tui-select>
                                <button
                                    type="button"
                                    class="consumption-manage__remove-item"
                                    appearance="accent"
                                    tuiButton
                                    size="l"
                                    iconStart="@tui.trash-2"
                                    [disabled]="first"
                                    (click)="removeItem(i)"
                                ></button>
                            </div>
                            <div class="consumption-manage__item-body">
                                @if (isProductItem(i)) {
                                    <div class="consumption-manage__field">
                                        <tui-textfield type="text">
                                            <label tuiLabel>{{ 'CONSUMPTION_MANAGE.ADD_PRODUCT_ROW.PRODUCT' | translate }}</label>
                                            <input
                                                tuiTextfield
                                                placeholder="{{ 'CONSUMPTION_MANAGE.ADD_PRODUCT_ROW.PRODUCT_PLACEHOLDER' | translate }}"
                                                [readOnly]="true"
                                                [value]="getProductName(i)"
                                                [invalid]="isProductInvalid(i)"
                                                (click)="onProductSelectClick(i)"
                                            />
                                        </tui-textfield>
                                        <tui-error
                                            formControlName="product"
                                            [error]="[] | tuiFieldError | async"
                                        ></tui-error>
                                    </div>
                                } @else {
                                    <div class="consumption-manage__field">
                                        <tui-textfield type="text">
                                            <label tuiLabel>{{ 'CONSUMPTION_MANAGE.ADD_RECIPE_ROW.RECIPE' | translate }}</label>
                                            <input
                                                tuiTextfield
                                                placeholder="{{ 'CONSUMPTION_MANAGE.ADD_RECIPE_ROW.RECIPE_PLACEHOLDER' | translate }}"
                                                [readOnly]="true"
                                                [value]="getRecipeName(i)"
                                                [invalid]="isRecipeInvalid(i)"
                                                (click)="onRecipeSelectClick(i)"
                                            />
                                        </tui-textfield>
                                        <tui-error
                                            formControlName="recipe"
                                            [error]="[] | tuiFieldError | async"
                                        ></tui-error>
                                    </div>
                                }
                                <div class="consumption-manage__field consumption-manage__field--amount">
                                    <tui-input-number formControlName="amount">
                                        <label tuiLabel>
                                            {{ 'CONSUMPTION_MANAGE.ADD_ITEM_ROW.AMOUNT' | translate }}
                                            @if (getAmountUnitLabel(i)) {
                                                <span class="consumption-manage__amount-unit">
                                                    ({{ getAmountUnitLabel(i) }})
                                                </span>
                                            }
                                        </label>
                                        <input tuiTextfieldLegacy placeholder="0" />
                                    </tui-input-number>
                                    <tui-error
                                        formControlName="amount"
                                        [error]="[] | tuiFieldError | async"
                                    ></tui-error>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="consumption-manage__item-buttons">
                    <button
                        type="button"
                        tuiButton
                        size="m"
                        appearance="primary"
                        iconStart="@tui.plus"
                        (click)="addProductItem()"
                    >
                        {{ 'CONSUMPTION_MANAGE.ADD_PRODUCT' | translate }}
                    </button>
                    <button
                        type="button"
                        tuiButton
                        size="m"
                        appearance="secondary"
                        iconStart="@tui.plus"
                        (click)="addRecipeItem()"
                    >
                        {{ 'CONSUMPTION_MANAGE.ADD_RECIPE' | translate }}
                    </button>
        </div>
            </fd-custom-group>
            <tui-error
                [error]="items.invalid && items.touched ? ('FORM_ERRORS.NON_EMPTY_ARRAY' | translate) : null"
            ></tui-error>
        </div>
        <div class="consumption-manage__comment">
            <tui-textfield type="text">
                <label tuiLabel>{{ 'CONSUMPTION_MANAGE.COMMENT' | translate }}</label>
                <input
                    formControlName="comment"
                    tuiTextfield
                    placeholder="{{ 'CONSUMPTION_MANAGE.COMMENT_PLACEHOLDER' | translate }}"
                />
            </tui-textfield>
            <tui-error
                formControlName="comment"
                [error]="[] | tuiFieldError | async"
            ></tui-error>
        </div>
        <fd-nutrients-summary
            [calories]="totalCalories()"
            [nutrientChartData]="nutrientChartData()"
            [fiberValue]="totalFiber()"
        ></fd-nutrients-summary>

        <div class="consumption-manage__actions">
            @if (consumption()) {
                <button
                    type="submit"
                    class="consumption-manage__submit-button"
                    tuiButton
                    appearance="primary"
                    iconStart="@tui.save"
                >
                    {{ 'CONSUMPTION_MANAGE.SAVE_BUTTON' | translate }}
                </button>
            } @else {
                <button
                    type="submit"
                    class="consumption-manage__submit-button"
                    tuiButton
                    appearance="primary"
                    iconStart="@tui.plus"
                >
                    {{ 'CONSUMPTION_MANAGE.ADD_BUTTON' | translate }}
                </button>
            }
            <tui-error [error]="globalError()"></tui-error>
        </div>
    </form>
</div>

<ng-template #confirmDialog let-observer>
    <div class="dialog">
        <p class="dialog__title">
            @if (consumption()) {
                {{ 'CONSUMPTION_MANAGE.EDIT_SUCCESS' | translate }}
            } @else {
                {{ 'CONSUMPTION_MANAGE.CREATE_SUCCESS' | translate }}
            }
        </p>
        <div class="dialog__buttons">
            <button tuiButton size="m" (click)="observer.next('Home'); observer.complete()">
                {{ 'CONSUMPTION_MANAGE.GO_TO_HOME_BUTTON' | translate }}
            </button>
            <button tuiButton size="m" (click)="observer.next('ConsumptionList'); observer.complete()">
                {{ 'CONSUMPTION_MANAGE.GO_TO_CONSUMPTION_LIST_BUTTON' | translate }}
            </button>
        </div>
    </div>
</ng-template>
