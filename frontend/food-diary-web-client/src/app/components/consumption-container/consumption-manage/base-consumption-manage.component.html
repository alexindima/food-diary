<div class="consumption-manage">
    <h2 class="consumption-manage__title">
        @if (consumption()) {
            {{ 'CONSUMPTION_MANAGE.EDIT_TITLE' | translate }}
        } @else {
            {{ 'CONSUMPTION_MANAGE.ADD_TITLE' | translate }}
        }
    </h2>

    <form class="consumption-manage__form" [formGroup]="consumptionForm" (ngSubmit)="onSubmit()">
        <div class="consumption-manage__date">
            <tui-input-date-time
                formControlName="date"
            >
                {{ 'CONSUMPTION_MANAGE.CHOOSE_DATE' | translate }}
            </tui-input-date-time>
            <tui-error
                formControlName="date"
                [error]="[] | tuiFieldError | async"
            ></tui-error>
        </div>
        <div class="consumption-manage__meal-type">
            <tui-select
                formControlName="mealType"
                [stringify]="stringifyMealType"
                [tuiTextfieldLabelOutside]="true"
            >
                {{ 'CONSUMPTION_MANAGE.MEAL_TYPE_LABEL' | translate }}
                <input
                    tuiTextfieldLegacy
                    placeholder="{{ 'CONSUMPTION_MANAGE.MEAL_TYPE_PLACEHOLDER' | translate }}"
                />
                <ng-template tuiDataList>
                    <tui-data-list>
                        @for (option of mealTypeOptions; track option) {
                            <button tuiOption [value]="option">
                                {{ ('MEAL_TYPES.' + option) | translate }}
                            </button>
                        }
                    </tui-data-list>
                </ng-template>
            </tui-select>
            <tui-error
                formControlName="mealType"
                [error]="[] | tuiFieldError | async"
            ></tui-error>
        </div>
        <div class="consumption-manage__consumption">
            <fd-custom-group
                [title]="'CONSUMPTION_MANAGE.ITEMS_GROUP_TITLE' | translate"
            >
                <div class="consumption-manage__items" formArrayName="items">
                    @for (item of items.controls; track item; let i = $index; let first = $first) {
                        <div class="consumption-manage__item" [formGroupName]="i">
                            <div class="consumption-manage__item-body">
                                <div class="consumption-manage__field">
                                    <tui-textfield type="text">
                                        <label tuiLabel>{{ 'CONSUMPTION_MANAGE.ITEM_SOURCE_LABEL' | translate }}</label>
                                        <input
                                            tuiTextfield
                                            [attr.placeholder]="('CONSUMPTION_MANAGE.ITEM_SOURCE_PLACEHOLDER' | translate)"
                                            [readOnly]="true"
                                            [value]="getItemSourceName(i)"
                                            [invalid]="isItemSourceInvalid(i)"
                                            (click)="onItemSourceClick(i)"
                                        />
                                    </tui-textfield>
                                    <tui-error [error]="getItemSourceError(i)"></tui-error>
                                </div>
                                <div class="consumption-manage__field consumption-manage__field--amount">
                                    <tui-input-number formControlName="amount">
                                        <label tuiLabel>
                                            {{ 'CONSUMPTION_MANAGE.ADD_ITEM_ROW.AMOUNT' | translate }}
                                            @if (getAmountUnitLabel(i)) {
                                                <span class="consumption-manage__amount-unit">
                                                    ({{ getAmountUnitLabel(i) }})
                                                </span>
                                            }
                                        </label>
                                        <input
                                            tuiTextfieldLegacy
                                            [attr.placeholder]="(getAmountPlaceholder(i) | translate)"
                                        />
                                    </tui-input-number>
                                    <tui-error
                                        formControlName="amount"
                                        [error]="[] | tuiFieldError | async"
                                    ></tui-error>
                                </div>
                                <button
                                    type="button"
                                    class="consumption-manage__remove-item"
                                    appearance="accent"
                                    tuiButton
                                    size="l"
                                    iconStart="@tui.trash-2"
                                    [disabled]="first"
                                    (click)="removeItem(i)"
                                ></button>
                            </div>
                        </div>
                    }
                </div>
                <div class="consumption-manage__item-buttons">
                    <button
                        type="button"
                        tuiButton
                        size="m"
                        appearance="primary"
                        iconStart="@tui.plus"
                        (click)="addConsumptionItem()"
                    >
                        {{ 'CONSUMPTION_MANAGE.ADD_ITEM' | translate }}
                    </button>
        </div>
            </fd-custom-group>
            <tui-error
                [error]="items.invalid && items.touched ? ('FORM_ERRORS.NON_EMPTY_ARRAY' | translate) : null"
            ></tui-error>
        </div>
        <div class="consumption-manage__comment">
            <tui-textfield type="text">
                <label tuiLabel>{{ 'CONSUMPTION_MANAGE.COMMENT' | translate }}</label>
                <input
                    formControlName="comment"
                    tuiTextfield
                    placeholder="{{ 'CONSUMPTION_MANAGE.COMMENT_PLACEHOLDER' | translate }}"
                />
            </tui-textfield>
            <tui-error
                formControlName="comment"
                [error]="[] | tuiFieldError | async"
            ></tui-error>
        </div>
        <fd-nutrients-summary
            [calories]="totalCalories()"
            [nutrientChartData]="nutrientChartData()"
            [fiberValue]="totalFiber()"
        ></fd-nutrients-summary>

        <div class="consumption-manage__actions">
            @if (consumption()) {
                <button
                    type="submit"
                    class="consumption-manage__submit-button"
                    tuiButton
                    appearance="primary"
                    iconStart="@tui.save"
                >
                    {{ 'CONSUMPTION_MANAGE.SAVE_BUTTON' | translate }}
                </button>
            } @else {
                <button
                    type="submit"
                    class="consumption-manage__submit-button"
                    tuiButton
                    appearance="primary"
                    iconStart="@tui.plus"
                >
                    {{ 'CONSUMPTION_MANAGE.ADD_BUTTON' | translate }}
                </button>
            }
            <tui-error [error]="globalError()"></tui-error>
        </div>
    </form>
</div>

<ng-template #confirmDialog let-observer>
    <div class="dialog">
        <p class="dialog__title">
            @if (consumption()) {
                {{ 'CONSUMPTION_MANAGE.EDIT_SUCCESS' | translate }}
            } @else {
                {{ 'CONSUMPTION_MANAGE.CREATE_SUCCESS' | translate }}
            }
        </p>
        <div class="dialog__buttons">
            <button tuiButton size="m" (click)="observer.next('Home'); observer.complete()">
                {{ 'CONSUMPTION_MANAGE.GO_TO_HOME_BUTTON' | translate }}
            </button>
            <button tuiButton size="m" (click)="observer.next('ConsumptionList'); observer.complete()">
                {{ 'CONSUMPTION_MANAGE.GO_TO_CONSUMPTION_LIST_BUTTON' | translate }}
            </button>
        </div>
    </div>
</ng-template>
