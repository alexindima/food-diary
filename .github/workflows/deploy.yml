name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_VERSION: 22
  SERVER_IP: 193.109.69.58
  FRONTEND_DIR: FoodDiary.Web.Client
  ADMIN_FRONTEND_BUILD_DIR: FoodDiary.Web.Client/dist/admin
  BACKEND_PROJECT: FoodDiary.Web.Api/FoodDiary.Web.Api.csproj
  BACKEND_PUBLISH_DIR: FoodDiary.Web.Api/publish
  BOT_PROJECT: FoodDiary.Telegram.Bot/FoodDiary.Telegram.Bot.csproj
  BOT_PUBLISH_DIR: FoodDiary.Telegram.Bot/publish
  JOBMANAGER_PROJECT: FoodDiary.JobManager/FoodDiary.JobManager.csproj
  JOBMANAGER_PUBLISH_DIR: FoodDiary.JobManager/publish
  ENABLE_JOBMANAGER: "false"
  FRONTEND_DEPLOY_DIR: /var/www/fooddiary.club
  ADMIN_FRONTEND_DEPLOY_DIR: /var/www/admin.fooddiary.club
  BACKEND_DEPLOY_DIR: /var/www/fooddiary-backend
  BOT_DEPLOY_DIR: /var/www/fooddiary-telegram-bot
  JOBMANAGER_DEPLOY_DIR: /var/www/food-diary-jobs

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Build Angular frontend
        run: |
          cd ${{ env.FRONTEND_DIR }}
          BUILD_VERSION="${GITHUB_SHA::8}"
          sed -i "s/__BUILD_VERSION__/${BUILD_VERSION}/g" src/environments/environment.prod.ts
          sed -i "s/__BUILD_VERSION__/${BUILD_VERSION}/g" src/environments/environment.staging.ts
          npm install
          npm run build:prod
          npm run build:admin
          echo "Frontend build completed."

      - name: Publish .NET backend
        run: |
          dotnet restore ${{ env.BACKEND_PROJECT }}
          dotnet publish ${{ env.BACKEND_PROJECT }} -c Release -o ${{ env.BACKEND_PUBLISH_DIR }}
          echo "Backend publish completed."

      - name: Publish Telegram bot
        run: |
          dotnet restore ${{ env.BOT_PROJECT }}
          dotnet publish ${{ env.BOT_PROJECT }} -c Release -o ${{ env.BOT_PUBLISH_DIR }}
          echo "Telegram bot publish completed."

      - name: Publish JobManager
        if: env.ENABLE_JOBMANAGER == 'true'
        run: |
          dotnet restore ${{ env.JOBMANAGER_PROJECT }}
          dotnet publish ${{ env.JOBMANAGER_PROJECT }} -c Release -o ${{ env.JOBMANAGER_PUBLISH_DIR }}
          echo "JobManager publish completed."

      - name: Build EF Core migration bundle
        run: |
          dotnet tool restore
          dotnet ef migrations bundle \
            --project ${{ env.BACKEND_PROJECT }} \
            --startup-project ${{ env.BACKEND_PROJECT }} \
            --configuration Release \
            --output ${{ env.BACKEND_PUBLISH_DIR }}/migrate

      - name: Setting up SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "SSH setup completed."

      - name: Creating directories on the server
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << EOF
          rm -rf "${{ env.FRONTEND_DEPLOY_DIR }}"
          rm -rf "${{ env.ADMIN_FRONTEND_DEPLOY_DIR }}"
          rm -rf "${{ env.BACKEND_DEPLOY_DIR }}"
          rm -rf "${{ env.BOT_DEPLOY_DIR }}"
          if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
            rm -rf "${{ env.JOBMANAGER_DEPLOY_DIR }}"
          fi
          mkdir -p "${{ env.FRONTEND_DEPLOY_DIR }}"
          mkdir -p "${{ env.ADMIN_FRONTEND_DEPLOY_DIR }}"
          mkdir -p "${{ env.BACKEND_DEPLOY_DIR }}"
          mkdir -p "${{ env.BOT_DEPLOY_DIR }}"
          if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
            mkdir -p "${{ env.JOBMANAGER_DEPLOY_DIR }}"
          fi
          chmod -R 755 "${{ env.FRONTEND_DEPLOY_DIR }}"
          chmod -R 755 "${{ env.ADMIN_FRONTEND_DEPLOY_DIR }}"
          chmod -R 755 "${{ env.BACKEND_DEPLOY_DIR }}"
          chmod -R 755 "${{ env.BOT_DEPLOY_DIR }}"
          if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
            chmod -R 755 "${{ env.JOBMANAGER_DEPLOY_DIR }}"
          fi
          chown -R www-data:www-data "${{ env.FRONTEND_DEPLOY_DIR }}"
          chown -R www-data:www-data "${{ env.ADMIN_FRONTEND_DEPLOY_DIR }}"
          chown -R www-data:www-data "${{ env.BACKEND_DEPLOY_DIR }}"
          chown -R www-data:www-data "${{ env.BOT_DEPLOY_DIR }}"
          if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
            chown -R www-data:www-data "${{ env.JOBMANAGER_DEPLOY_DIR }}"
          fi
          echo "Directories created, cleaned, and permissions set."
          EOF

      - name: Install .NET runtime and configure systemd service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << 'EOF'
            set -e
            # Install ASP.NET Core Runtime 10.0 if missing
            if ! command -v dotnet >/dev/null 2>&1 || ! dotnet --list-runtimes | grep -q "Microsoft.AspNetCore.App 10"; then
              wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
              dpkg -i packages-microsoft-prod.deb
              rm -f packages-microsoft-prod.deb
              apt-get update
              apt-get install -y aspnetcore-runtime-10.0
            fi

            # Write/refresh systemd unit
            printf "%s\n" \
              "[Unit]" \
              "Description=FoodDiary API" \
              "After=network.target" \
              "" \
              "[Service]" \
              "WorkingDirectory=${{ env.BACKEND_DEPLOY_DIR }}" \
              "ExecStart=/usr/bin/dotnet FoodDiary.Web.Api.dll" \
              "Restart=always" \
              "RestartSec=5" \
              "SyslogIdentifier=food-diary-api" \
              "User=www-data" \
              "Environment=ASPNETCORE_ENVIRONMENT=Production" \
              "EnvironmentFile=/etc/fooddiary/fooddiary.env" \
              "" \
              "[Install]" \
              "WantedBy=multi-user.target" \
              > /etc/systemd/system/food-diary-api.service

            printf "%s\n" \
              "[Unit]" \
              "Description=FoodDiary Telegram bot" \
              "After=network.target" \
              "" \
              "[Service]" \
              "WorkingDirectory=${{ env.BOT_DEPLOY_DIR }}" \
              "ExecStart=/usr/bin/dotnet FoodDiary.Telegram.Bot.dll" \
              "Restart=always" \
              "RestartSec=5" \
              "SyslogIdentifier=food-diary-telegram-bot" \
              "User=www-data" \
              "Environment=ASPNETCORE_ENVIRONMENT=Production" \
              "EnvironmentFile=/etc/fooddiary/fooddiary.env" \
              "" \
              "[Install]" \
              "WantedBy=multi-user.target" \
              > /etc/systemd/system/food-diary-telegram-bot.service

            if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
              printf "%s\n" \
                "[Unit]" \
                "Description=FoodDiary background jobs" \
                "After=network.target" \
                "" \
                "[Service]" \
                "WorkingDirectory=${{ env.JOBMANAGER_DEPLOY_DIR }}" \
                "ExecStart=/usr/bin/dotnet FoodDiary.JobManager.dll" \
                "Restart=always" \
                "RestartSec=5" \
                "SyslogIdentifier=food-diary-jobs" \
                "User=www-data" \
                "Environment=ASPNETCORE_ENVIRONMENT=Production" \
                "EnvironmentFile=/etc/fooddiary/fooddiary.env" \
                "" \
                "[Install]" \
                "WantedBy=multi-user.target" \
                > /etc/systemd/system/food-diary-jobs.service
            fi

            systemctl daemon-reload
            systemctl enable food-diary-api
            systemctl enable food-diary-telegram-bot
          EOF

      - name: Uploading frontend files
        run: |
          START_TIME=$(date +%s)
          NUM_FILES=$(find ${{ env.FRONTEND_DIR }}/dist -type f | wc -l)
          echo "$NUM_FILES files to upload."
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.FRONTEND_DIR }}/dist/ root@${{ env.SERVER_IP }}:${{ env.FRONTEND_DEPLOY_DIR }}/
          END_TIME=$(date +%s)
          echo "Uploaded $NUM_FILES files in $(($END_TIME - $START_TIME)) seconds."

      - name: Uploading admin frontend files
        run: |
          START_TIME=$(date +%s)
          NUM_FILES=$(find ${{ env.ADMIN_FRONTEND_BUILD_DIR }} -type f | wc -l)
          echo "$NUM_FILES admin files to upload."
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.ADMIN_FRONTEND_BUILD_DIR }}/ root@${{ env.SERVER_IP }}:${{ env.ADMIN_FRONTEND_DEPLOY_DIR }}/
          END_TIME=$(date +%s)
          echo "Uploaded $NUM_FILES admin files in $(($END_TIME - $START_TIME)) seconds."

      - name: Uploading backend files
        run: |
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.BACKEND_PUBLISH_DIR }}/ root@${{ env.SERVER_IP }}:${{ env.BACKEND_DEPLOY_DIR }}/

      - name: Uploading telegram bot files
        run: |
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.BOT_PUBLISH_DIR }}/ root@${{ env.SERVER_IP }}:${{ env.BOT_DEPLOY_DIR }}/

      - name: Uploading job manager files
        if: env.ENABLE_JOBMANAGER == 'true'
        run: |
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.JOBMANAGER_PUBLISH_DIR }}/ root@${{ env.SERVER_IP }}:${{ env.JOBMANAGER_DEPLOY_DIR }}/

      - name: Run migration bundle on server
        env:
          CONNECTION_STRING: ${{ secrets.PROD_CONNECTION_STRING }}
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << EOF
            set -e
            if [ -z "${CONNECTION_STRING}" ]; then
              echo "Missing CONNECTION_STRING env for migrations" >&2
              exit 1
            fi
            cd "${{ env.BACKEND_DEPLOY_DIR }}"
            chmod +x ./migrate

            export ConnectionStrings__DefaultConnection="${CONNECTION_STRING}"

            ./migrate
            echo "Migrations applied by bundle."
          EOF

      - name: Restart backend service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << EOF
          systemctl restart food-diary-api
          systemctl status food-diary-api --no-pager -n 20 || true
          systemctl restart food-diary-telegram-bot
          systemctl status food-diary-telegram-bot --no-pager -n 20 || true
          if [ "${ENABLE_JOBMANAGER}" = "true" ]; then
            systemctl restart food-diary-jobs
            systemctl status food-diary-jobs --no-pager -n 20 || true
          fi
          EOF

      - name: Confirm deployment completion
        run: |
          echo "===================================="
          echo "DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "===================================="
