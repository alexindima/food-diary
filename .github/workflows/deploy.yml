name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NODE_VERSION: 22
  SERVER_IP: 193.109.69.58
  FRONTEND_DIR: frontend/food-diary-web-client
  BACKEND_PROJECT: FoodDiary.Web.Api/FoodDiary.Web.Api.csproj
  BACKEND_PUBLISH_DIR: FoodDiary.Web.Api/publish
  FRONTEND_DEPLOY_DIR: /var/www/fooddiary.club
  BACKEND_DEPLOY_DIR: /var/www/fooddiary-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Build Angular frontend
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm install
          npm run build:prod
          echo "Frontend build completed."

      - name: Publish .NET backend
        run: |
          dotnet restore ${{ env.BACKEND_PROJECT }}
          dotnet publish ${{ env.BACKEND_PROJECT }} -c Release -o ${{ env.BACKEND_PUBLISH_DIR }}
          echo "Backend publish completed."

      - name: Setting up SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "SSH setup completed."

      - name: Creating directories on the server
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << EOF
          rm -rf "${{ env.FRONTEND_DEPLOY_DIR }}"
          rm -rf "${{ env.BACKEND_DEPLOY_DIR }}"
          mkdir -p "${{ env.FRONTEND_DEPLOY_DIR }}"
          mkdir -p "${{ env.BACKEND_DEPLOY_DIR }}"
          chmod -R 755 "${{ env.FRONTEND_DEPLOY_DIR }}"
          chmod -R 755 "${{ env.BACKEND_DEPLOY_DIR }}"
          chown -R www-data:www-data "${{ env.FRONTEND_DEPLOY_DIR }}"
          chown -R www-data:www-data "${{ env.BACKEND_DEPLOY_DIR }}"
          echo "Directories created, cleaned, and permissions set."
          EOF

      - name: Install .NET runtime and configure systemd service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << 'EOF'
            set -e
            # Install ASP.NET Core Runtime 9.0 if missing
            if ! command -v dotnet >/dev/null 2>&1 || ! dotnet --list-runtimes | grep -q "Microsoft.AspNetCore.App 9"; then
              wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
              dpkg -i packages-microsoft-prod.deb
              rm -f packages-microsoft-prod.deb
              apt-get update
              apt-get install -y aspnetcore-runtime-9.0
            fi

            # Write/refresh systemd unit
            printf "%s\n" \
              "[Unit]" \
              "Description=FoodDiary API" \
              "After=network.target" \
              "" \
              "[Service]" \
              "WorkingDirectory=${{ env.BACKEND_DEPLOY_DIR }}" \
              "ExecStart=/usr/bin/dotnet FoodDiary.Web.Api.dll" \
              "Restart=always" \
              "RestartSec=5" \
              "SyslogIdentifier=food-diary-api" \
              "User=www-data" \
              "Environment=ASPNETCORE_ENVIRONMENT=Production" \
              "# TODO: add real secrets/connection strings as Environment=... or EnvironmentFile=" \
              "" \
              "[Install]" \
              "WantedBy=multi-user.target" \
              > /etc/systemd/system/food-diary-api.service

            systemctl daemon-reload
            systemctl enable food-diary-api
          EOF

      - name: Uploading frontend files
        run: |
          START_TIME=$(date +%s)
          NUM_FILES=$(find ${{ env.FRONTEND_DIR }}/dist -type f | wc -l)
          echo "$NUM_FILES files to upload."
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.FRONTEND_DIR }}/dist/ root@${{ env.SERVER_IP }}:${{ env.FRONTEND_DEPLOY_DIR }}/
          END_TIME=$(date +%s)
          echo "Uploaded $NUM_FILES files in $(($END_TIME - $START_TIME)) seconds."

      - name: Uploading backend files
        run: |
          rsync -az --quiet --human-readable -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            ${{ env.BACKEND_PUBLISH_DIR }}/ root@${{ env.SERVER_IP }}:${{ env.BACKEND_DEPLOY_DIR }}/

      - name: Restart backend service
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@${{ env.SERVER_IP }} << EOF
          systemctl restart food-diary-api
          systemctl status food-diary-api --no-pager -n 20 || true
          EOF

      - name: Confirm deployment completion
        run: |
          echo "===================================="
          echo "DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "===================================="
